<?xml version="1.0" encoding="UTF-8"?>
<!-- You may freely edit this file. See harness/README in the NetBeans platform -->
<!-- for some information on what you could do (e.g. targets to override). -->
<!-- If you delete this file and reopen the project it will be recreated. -->
<project name="o.mozilla.rhino.patched" default="netbeans" basedir=".">
    <description>Builds, tests, and runs the project org.mozilla.rhino.patched</description>
    <import file="../nbbuild/templates/projectized.xml"/>

    <target name="init" depends="projectized.init">
        <!-- Avoid confusing NetBeans when it has the project open. Having
             source files come and go underneath it makes the package view
             and friends very unhappy. Just rely on file overwrites instead;
             it handles that better (presumably because the directories stay
             intact.)
        <delete dir="${patched_source}"/>
        <mkdir dir="${patched_source}"/>
        -->
        <unzip dest="${patched_source}">
            <fileset dir="external/">
                <include name="rhino*.zip"/>
            </fileset>
        </unzip>

        <!-- Repackage the sources as org.mozilla.nb such that we have no class name
             conflicts if people try to have Rhino as a scripting engine -->
        <mkdir dir="${src.dir}/org/mozilla/nb"/>
        <move file="${src.dir}/org/mozilla/javascript" tofile="${src.dir}/org/mozilla/nb/javascript"/>
        <move file="${src.dir}/org/mozilla/classfile" tofile="${src.dir}/org/mozilla/nb/classfile"/>
        <replace dir="${patched_source}">
            <include name="**"/>
            <replacefilter token="org.mozilla" value="org.mozilla.nb"/>
            <replacefilter token="org-mozilla" value="org-mozilla-nb"/>
            <replacefilter token="org/mozilla" value="org/mozilla/nb"/>
        </replace>

        <!-- Insert module description bundle etc. -->
        <copy todir="${src.dir}" overwrite="true">
            <fileset dir="src" />
        </copy>

        <echo>Patching ${src.dir}</echo>
        <!--
        <patch dir="${src.dir}" patchfile="rhino.diff" strip="2" ignorewhitespace="true" reverse="false"/>
        -->
        <copy todir="${src.dir}" overwrite="true">
            <fileset dir="patched_files" />
        </copy>
        <delete file="${src.dir}/build.xml"/>
        <delete file="${src.dir}/manifest"/>


        <!-- Try to delete classes we don't use to prune down the distro a bit - we only need the parser -->
        <!--
        ... This is not yet done, so it's commented out
        <delete dir="${src.dir}/org/mozilla/patched/classfile"/>
        <delete dir="${src.dir}/org/mozilla/patched/javascript">
            
            <include name="optimizer/**"/>
            <include name="regexp/**"/>
            <include name="xml/**"/>
            <include name="jdk11/**"/>
            <include name="jdk13/**"/>
            <include name="jdk15/**"/>
            <include name="serialize/**"/>
            <include name="continuations/**"/>
            <include name="debug/**"/>

            <include name="Java*.java"/>
            <include name="Native*.java"/>
            <include name="*SecurityController.java"/>
            <include name="*ScriptableObject.java"/>
            <include name="*FunctionObject.java"/>
            <include name="Interpreter*.java"/>
            <include name="Wrap*.java"/>

            <include name="JavaMembers.java"/>
            <include name="IdFunctionCall.java"/>
            <include name="ClassCache.java"/>
            <include name="Arguments.java"/>
            <include name="InterpretedFunction.java"/>
            <include name="BaseFunction.java"/>
            <include name="ImporterTopLevel.java"/>
            <include name="Codegen.java"/>
            <include name="LazilyLoadedCtor.java"/>
            <include name="RhinoException.java"/>
            <include name="EcmaError.java"/>
            <include name="VMBridge.java"/>
            <include name="EvaluatorException.java"/>
            <include name="SpecialRef.java"/>
            <include name="MemberBox.java"/>
            <include name="InterfaceAdapter.java"/>
        </delete>
        -->

    </target>    

    <target name="clean" depends="projectized-common.clean">
        <delete dir="${patched_source}"/>
        <!-- HACK: For some reason the clean target doesn't get expansions for the logical dirs... -->
        <delete dir="patched_source"/>
    </target>

    <target name="check-run-mlbuild" depends="build-init">
        <property name="translated.src.dir" location="${nb_all}/translatedfiles/src/${module.name}/src"/>
        <available file="${translated.src.dir}" type="dir" property="translated.src.dir.exist"/>
        <condition property="run.ml.build" value="true">
            <and>
                <isset property="translated.src.dir.exist"/>
                <isset property="locjar.locales"/>
                <length string="${locjar.locales}" when="greater" length="0"/>
            </and>
        </condition>
    </target>

    <target name="pre-jar-ml" depends="build-init,check-run-mlbuild" if="run.ml.build">
        <mkdir dir="${build.classes.dir.ml}"/>
        <copy todir="${build.classes.dir.ml}">
            <!-- #58298: strip comments to save some space -->
            <fileset dir="${translated.src.dir}" includes="**/*.properties"/>
            <filterchain>
                <tokenfilter>
                    <!-- #61965: preserve #NOI18N and similar comments -->
                    <filetokenizer/>
                    <replaceregex pattern="^#(?!(PART)?(NO)?I18N).*[\r\n]+" replace="" flags="gm"/>
                </tokenfilter>
            </filterchain>
        </copy>
    </target>

</project>
