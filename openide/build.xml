<?xml version='1.0' encoding='ISO-8859-1' ?>
<!--
                Sun Public License Notice

The contents of this file are subject to the Sun Public License
Version 1.0 (the "License"). You may not use this file except in
compliance with the License. A copy of the License is available at
http://www.sun.com/

The Original Code is NetBeans. The Initial Developer of the Original
Code is Sun Microsystems, Inc. Portions Copyright 1997-2000 Sun
Microsystems, Inc. All Rights Reserved.
-->

<!-- Special properties: -->
<!-- -Dproxy=proxy.netbeans.com:3128 to use an HTTP proxy for building APIs -->
<!-- -Djdkdocs=.../api (optional) -->
<!-- Special targets: apiexamples, open-apis -->

<!-- ToDo: modern compile can fail even within openide/src for the same -->
<!-- reasons other modules need openide-13javac-workaround.jar! -->
<!-- Not clear how to solve this. Try rerunning build if it happens. -->

<project name="openide" default="netbeans" basedir=".">
  <property name="jdkdocs" value="public"/>
  <property name="binroot" value=".."/>

  <taskdef name="tojar" classname="org.netbeans.nbbuild.ToJar" classpath="../nbbuild/nbantext.jar"/>
  <taskdef name="preprocess" classname="org.netbeans.nbbuild.Preprocess" classpath="../nbbuild/nbantext.jar"/>

  <target name="init">
    <available property="jdk13proxies" classname="java.lang.reflect.Proxy"/>
    <available property="javasound" classname="javax.sound.sampled.AudioSystem"/>
  </target>

  <target name="warn-re-jdk13proxies" depends="init" unless="jdk13proxies">
    <echo message="Warning: due to lack of JDK 1.3 proxies in your compile environment,"/>
    <echo message="this support will not be built and the IDE will not work in JDK 1.3."/>
    <echo message="(Or at least not as efficiently as it would if built with 1.3.)"/>
  </target>
  <target name="compile-regular" depends="init,warn-re-jdk13proxies">
    <javac srcdir="src" destdir="src">
      <exclude name="**/org/openide/util/WeakListener13.java" unless="jdk13proxies"/>
      <classpath>
        <pathelement location="${binroot}/core/release/lib/ext/regexp.jar"/>
        <pathelement location="${binroot}/core/release/lib/ext/jaxp.jar"/>
        <pathelement location="${binroot}/core/release/lib/ext/parser.jar"/>
      </classpath>
    </javac>
  </target>
  
  <target name="compile" depends="compile-regular, compile-preprocessed">
  </target>
  
  <target name="compile-preprocessed" depends="preprocess" >
    <javac srcdir="tmp" destdir="src">
      <classpath>
        <pathelement location="tmp"/>
        <pathelement location="src"/>
        <pathelement location="${binroot}/core/release/lib/ext/regexp.jar"/>
        <pathelement location="${binroot}/core/release/lib/ext/jaxp.jar"/>
        <pathelement location="${binroot}/core/release/lib/ext/parser.jar"/>
      </classpath>
    </javac>
  </target>

  <target name="preprocess">
    <preprocess srcdir="src" destdir="tmp" >
      <include name="**/*.java" />
    </preprocess>
  </target>
  
  <target name="clean-preprocess">
    <delete dir="tmp" />
  </target>

  <target name="jars" depends="compile">
    <mkdir dir="netbeans/lib"/>
    <filter token="BUILD_NUMBER_SUBST" value="${buildnumber}"/>
    <copy file="manifest.mf" tofile="manifest-subst.mf" filtering="on"/>
    <jar jarfile="netbeans/lib/openide.jar"
         manifest="manifest-subst.mf"
         basedir="src"
	 excludesfile="../nbbuild/standard-jar-excludes.txt"
	 compress="false"/>
    <!-- JDK 1.3 Javac at least on Linux has a serious bug as regards -->
    <!-- situations where one package contains a public class and a public -->
    <!-- inner class of the same name: though the inner class should be qualified -->
    <!-- by its outer class, something gets confused and the compiler thinks -->
    <!-- it cannot find the simple class whenever it is used. -->
    <!-- Forcing use of 1.2 compiler is possible with -Dbuild.compiler=classic, -->
    <!-- but this slows down builds, messes up Jikes users, and is not apparently -->
    <!-- needed for all 1.3 Javac versions. Easier to ensure that the outer classes -->
    <!-- appear in a separate JAR file at compile time, this assuages the compiler. -->
    <jar jarfile="openide-13javac-workaround.jar"
         basedir="src"
         compress="false">
      <!-- Compare inner classes of Actions: -->
      <include name="org/openide/awt/ToolbarButton*.class"/>
      <exclude name="org/openide/awt/ToolbarButtonUI*.class"/>
      <include name="org/openide/awt/ToolbarToggleButton*.class"/>
      <!-- Compare inner class of RequestProcessor: -->
      <include name="org/openide/util/Task*.class"/>
      <exclude name="org/openide/util/TaskListener*.class"/>
    </jar>
  </target>

  <target name="netbeans" depends="jars"/>

  <!-- Open API documentation. -->

  <!-- XXX don't build unless out of date -->
  <!-- XXX preferably would be a special task to do all this stuff... -->
  <target name="open-apis" depends="open-apis-premessage,open-apis-noproxy,open-apis-proxy"/>
  <target name="open-apis-noproxy" unless="proxy">
    <exec dir="." command="perl api/doc/build --output OpenAPIs --noshowstatus --jdkurl ${jdkdocs} --zip zip --zipbare --zipandkill --nofastlinks" os="Linux" output="OpenAPIs.log" failonerror="yes"/>
    <exec dir="." command="perl api/doc/build --output OpenAPIs --noshowstatus --jdkurl ${jdkdocs} --zip zip --zipbare --zipandkill --nofastlinks" os="SunOS" output="OpenAPIs.log" failonerror="yes"/>
    <!-- Missing initial W intentional: -->
    <exec dir="." command="echo Sorry, no Windows support for building OpenAPIs documentation yet" os="indows" output="con:"/>
  </target>
  <target name="open-apis-proxy" if="proxy">
    <exec dir="." command="perl api/doc/build --output OpenAPIs --noshowstatus --jdkurl ${jdkdocs} --zip zip --zipbare --zipandkill --nofastlinks --proxy ${proxy}" os="Linux" output="OpenAPIs.log" failonerror="yes"/>
    <exec dir="." command="perl api/doc/build --output OpenAPIs --noshowstatus --jdkurl ${jdkdocs} --zip zip --zipbare --zipandkill --nofastlinks --proxy ${proxy}" os="SunOS" output="OpenAPIs.log" failonerror="yes"/>
    <exec dir="." command="echo Sorry, no Windows support for building OpenAPIs documentation yet" os="Windows NT" output="con:"/>
    <exec dir="." command="echo Sorry, no Windows support for building OpenAPIs documentation yet" os="Windows 2000" output="con:"/>
  </target>
  <target name="open-apis-premessage">
    <echo message="Building Open APIs...warning, this may take a while."/>
  </target>

  <!-- API examples. -->

  <target name="examplemodules" depends="example-scripts,example-minicomposer-nodice,example-minicomposer,example-globalactions"/>

  <target name="example-scripts" depends="jars">
    <javac srcdir="api/examples" destdir="api/examples">
      <include name="**/org/netbeans/examples/scripts/"/>
      <classpath>
        <pathelement location="netbeans/lib/openide.jar"/>
      </classpath>
    </javac>
  </target>

  <target name="example-minicomposer-nodice" depends="init" unless="javasound">
    <echo message="Sorry, minicomposer example requires JavaSound to be built."/>
    <echo message="Included in JDK 1.3, else you may need to download it separately."/>
  </target>
  <target name="example-minicomposer" depends="init,jars" if="javasound">
    <javac srcdir="api/examples" destdir="api/examples">
      <include name="**/org/netbeans/examples/modules/minicomposer/"/>
      <classpath>
        <pathelement location="netbeans/lib/openide.jar"/>
      </classpath>
    </javac>
    <tojar srcdir="api/examples" unpackeddir="api/examples/org/netbeans/examples/modules/minicomposer_tojar"/>
    <mkdir dir="examplemodules"/>
    <!-- Note: compression on, because these things are frequently emailed, -->
    <!-- and performance is irrelevant. -->
    <!-- Note also that sources are intentionally included. -->
    <!-- filesystem.attributes OK too, since people may want to unpack & fool with source. -->
    <jar jarfile="examplemodules/minicomposer.jar"
         manifest="api/examples/org/netbeans/examples/modules/minicomposer.mf"
	 basedir="api/examples"
	 includes="org/netbeans/examples/modules/minicomposer/"
	 excludes="**/*.jar.MAKEME"
	 compress="true"/>
  </target>

  <target name="openidex-all" depends="netbeans">
    <ant dir="../openidex"/>
  </target>
  <target name="example-globalactions" depends="jars,openidex-all">
    <javac srcdir="api/examples" destdir="api/examples">
      <include name="org/netbeans/examples/modules/globalactions/"/>
      <classpath>
        <pathelement location="netbeans/lib/openide.jar"/>
        <pathelement location="../openidex/netbeans/lib/ext/openidex.jar"/>
      </classpath>
    </javac>
    <mkdir dir="examplemodules"/>
    <jar jarfile="examplemodules/globalactions.jar"
         manifest="api/examples/org/netbeans/examples/modules/globalactions.mf"
	 basedir="api/examples"
	 includes="org/netbeans/examples/modules/globalactions/"
	 compress="true"/>
  </target>

  <target name="apiexamples" depends="netbeans,examplemodules">
    <ant dir="../sysprops"/>
    <ant dir="../serialversion"/>
    <mkdir dir="examplemodules/apiexamples"/>
    <copy todir="examplemodules/apiexamples">
      <fileset dir="api/examples">
        <include name="org/netbeans/examples/modules/minicomposer/"/>
        <exclude name="org/netbeans/examples/modules/minicomposer/templates.jar.MAKEME"/>
        <include name="org/netbeans/examples/modules/globalactions/"/>
        <include name="org/netbeans/examples/scripts/"/>
      </fileset>
    </copy>
    <copy todir="examplemodules/apiexamples">
      <fileset dir="../sysprops/src"/>
    </copy>
    <copy todir="examplemodules/apiexamples">
      <fileset dir="../serialversion/src"/>
    </copy>
    <mkdir dir="examplemodules/apiexamples/manifests"/>
    <filter token="BUILD_NUMBER_SUBST" value="(demo module)"/>
    <copy file="api/examples/org/netbeans/examples/modules/minicomposer.mf"
          tofile="examplemodules/apiexamples/manifests/minicomposer.mf"/>
    <copy file="api/examples/org/netbeans/examples/modules/globalactions.mf"
          tofile="examplemodules/apiexamples/manifests/globalactions.mf"/>
    <copy file="../sysprops/manifest.mf"
          tofile="examplemodules/apiexamples/manifests/sysprops.mf"
	  filtering="true"/>
    <copy file="../serialversion/manifest.mf"
          tofile="examplemodules/apiexamples/manifests/serialversion.mf"
	  filtering="true"/>
    <zip zipfile="examplemodules/apiexamples.zip"
         basedir="examplemodules/apiexamples"
	 compress="true"/>
  </target>

  <target name="clean" depends="clean-preprocess">
    <delete>
      <fileset dir="src">
        <include name="**/*.class"/>
      </fileset>
    </delete>
    <delete>
      <fileset dir="api/examples">
        <include name="**/*.class"/>
      </fileset>
    </delete>
    <delete file="manifest-subst.mf"/>
    <delete dir="netbeans"/>
    <delete file="openide-13javac-workaround.jar"/>
    <delete dir="OpenAPIs"/>
    <!-- <delete file="OpenAPIs.zip"/> -->
    <echo message="Will not remove OpenAPIs.zip, remove it yourself if desired..."/>
    <delete file="OpenAPIs.log"/>
    <delete dir="examplemodules"/>
    <delete file="api/examples/org/netbeans/examples/modules/minicomposer/templates.jar"/>
  </target>

</project>
