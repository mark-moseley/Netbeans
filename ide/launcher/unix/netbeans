#!/bin/sh
# The contents of this file are subject to the terms of the Common Development
# and Distribution License (the License). You may not use this file except in
# compliance with the License.
#
# You can obtain a copy of the License at http://www.netbeans.org/cddl.html
# or http://www.netbeans.org/cddl.txt.
#
# When distributing Covered Code, include this CDDL Header Notice in each file
# and include the License file at http://www.netbeans.org/cddl.txt.
# If applicable, add the following below the CDDL Header, with the fields
# enclosed by brackets [] replaced by your own identifying information:
# "Portions Copyrighted [year] [name of copyright owner]"
#
# The Original Software is NetBeans. The Initial Developer of the Original
# Software is Sun Microsystems, Inc. Portions Copyright 1997-2007 Sun
# Microsystems, Inc. All Rights Reserved.

#
# resolve symlinks
#

PRG=$0

while [ -h "$PRG" ]; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '^.*-> \(.*\)$' 2>/dev/null`
    if expr "$link" : '^/' 2> /dev/null >/dev/null; then
	PRG="$link"
    else
	PRG="`dirname "$PRG"`/$link"
    fi
done

progdir=`dirname "$PRG"`

if [ -f "$progdir"/../etc/netbeans.conf ] ; then
    . "$progdir"/../etc/netbeans.conf
fi

# following should be done just in RPM or Solaris Launcher
# if [ -f /etc/netbeans.conf ] ; then
#     . /etc/netbeans.conf
# fi


# #68373: look for userdir, but do not modify "$@"
userdir="${netbeans_default_userdir}"
founduserdir=""
for opt in "$@"; do
    if [ "${founduserdir}" = "yes" ]; then
        userdir="$opt"
        break
    elif [ "$opt" = "--userdir" ]; then
        founduserdir="yes"
    fi
done

if [ -f "${userdir}"/etc/netbeans.conf ] ; then
    . "${userdir}"/etc/netbeans.conf
fi


if [ ! -f "$progdir"/../etc/netbeans.clusters ]; then
    echo Cannot read cluster file: "$progdir"/../etc/netbeans.clusters 1>&2
    exit 1
fi

readClusters() {
    grep -v "^#" "$progdir"/../etc/netbeans.clusters | grep -v "^$" | grep -v platform | while read X; do
        if [ -d "$progdir"/../$X ]; then
            echo $progdir/../$X
        elif [ -d "$X" ]; then
            echo $X
        elif expr "$X" : ".*/" >/dev/null; then
            echo $X
        else
            echo $progdir/../$X
        fi
    done
}

absolutize_paths() {
    while read path; do
        if [ -d "$path" ]; then
            (cd "$path" 2>/dev/null && pwd)
        fi
    done
}

netbeans_clusters=`readClusters | absolutize_paths | tr '\012' ':'`

if [ ! -z "$netbeans_extraclusters" ] ; then
    netbeans_clusters="$netbeans_clusters:$netbeans_extraclusters"
fi

heap_size () {
    mem=128
    case "`uname`" in
        Linux*)
        mem=`cat /proc/meminfo | grep MemTotal | tr -d [:space:][:alpha:]:`
        mem=`expr $mem / 4096`
        ;;
    SunOS*)
        mem=`/usr/sbin/prtconf | grep Memory | /usr/xpg4/bin/tr -dc '[:digit:]'`
        mem=`expr $mem / 4`
        ;;
# Disable the heuristics on Mac until we resolve #106965
#    Darwin*)
#        mem=`sysctl hw.physmem | tr -d [:alpha:][:space:].:`
#        mem=`expr $mem / 4194304`
#        ;;
        *) 
        ;;
    esac
    if [ $mem -gt 512 ] ; then
        mem=512
    elif [ $mem -lt 96 ] ; then
        mem=96
    fi
    max_heap_size=$mem
    return 0
}


if grep -v -- "-J-Xmx" >/dev/null <<EOF ; then
${netbeans_default_options}
EOF
        heap_size
	netbeans_default_options="-J-Xmx${max_heap_size}m ${netbeans_default_options}"
fi

# filter CMS options on Mac, see #106965
if uname | grep 'Darwin' > /dev/null; then
        netbeans_default_options=`echo $netbeans_default_options |tr " " "\n" |grep -v -E CMS\|[+]UseConcMarkSweep |tr "\n" " "`
fi

launchNbexec() {
    nbexec=`grep -v "^#" "$progdir"/../etc/netbeans.clusters | grep -v "^$" | grep platform | while read X; do
        if [ -f "$progdir"/../$X/lib/nbexec ]; then
            echo "$progdir"/../$X/lib/nbexec
        fi
    done | head -n 1`
    sh=sh
    # #73162: Ubuntu uses the ancient Bourne shell, which does not implement trap well.
    if [ -x /bin/bash ]
    then
        sh=/bin/bash
    fi
    if [ "${founduserdir}" = "yes" ]; then
        exec $sh "$nbexec" "$@"
    else
        exec $sh "$nbexec" --userdir "${userdir}" "$@"
    fi
}

# in case of macosx, the apple.laf.useScreenMenuBar property should be ideally in the Info.plist file
# but it doesn't get propagated into the executed java VM. 
case "`uname`" in
    Darwin*)
        eval launchNbexec \
            --jdkhome '"$netbeans_jdkhome"' \
            -J-Dcom.apple.mrj.application.apple.menu.about.name=NetBeans \
            -J-Xdock:name=NetBeans \
            '"-J-Xdock:icon=$progdir/../nb6.0/netbeans.icns"' \
            --branding nb \
            --clusters '"$netbeans_clusters"' \
            -J-Dnetbeans.importclass=org.netbeans.upgrade.AutoUpgrade \
            -J-Dnetbeans.accept_license_class=org.netbeans.license.AcceptLicense \
            ${netbeans_default_options} \
            '"$@"'
        ;;
    *)
        eval launchNbexec \
            --jdkhome '"$netbeans_jdkhome"' \
            --branding nb \
            --clusters '"$netbeans_clusters"' \
            -J-Dnetbeans.importclass=org.netbeans.upgrade.AutoUpgrade \
            -J-Dnetbeans.accept_license_class=org.netbeans.license.AcceptLicense \
            ${netbeans_default_options} \
            '"$@"'
        ;;
esac
