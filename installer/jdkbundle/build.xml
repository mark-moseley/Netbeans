<!--
                Sun Public License Notice

The contents of this file are subject to the Sun Public License
Version 1.0 (the "License"). You may not use this file except in
compliance with the License. A copy of the License is available at
http://www.sun.com/

The Original Code is NetBeans. The Initial Developer of the Original
Code is Sun Microsystems, Inc. Portions Copyright 1997-2005 Sun
Microsystems, Inc. All Rights Reserved.
-->

<project name="NetBeans JDK Bundle Installer" default="build" basedir=".">

  <property file="nbproject/private/private.properties"/>  
  <property file="build.properties" />

  <property name="storage.builder" location="../../java/storagebuilder/dist/storagebuilder.jar"/>
  <property name="preparse.files" location="../../java/storagebuilder/preparse-files.txt"/>
  <property name="nb.dir" location="../../nbbuild/netbeans"/>
 
  <target name="init" depends="set-buildnumber, set-installer.basename" unless="inited">
    <property name="inited" value="true" />
  </target>
  
  <target name="init-ml" depends="init, copy-localized-data" unless="inited-ml">
    <property name="inited-ml" value="true" />
  </target>
  
  <target name="copy-localized-data">
      <copy todir="." failonerror="false">
          <fileset dir="../../translatedfiles/src/installer/jdkbundle"/>
      </copy>
  </target>
  
  <target name="set-ismp.cp" unless="ismp.cp-set">
    <path id="ismp.cp">        
        <pathelement path="${ismp.home}" />
        <pathelement path="${ismp.home}/i18n" />
        <fileset dir="${ismp.home}">
          <include name="lib/*.jar"/>
          <include name="ppk/*.jar"/>
          <exclude name="lib/conversion.jar"/>
        </fileset>        
        <fileset dir="../lib">
          <include name="dist/*.jar"/>
        </fileset>
    </path>
    <property name="ismp.cp-set" value="true" />
  </target>

  <target name="set-buildnumber" unless="buildnumber">
    <tstamp>
    	<format property="buildnumber" pattern="yyMMdd"/>
    </tstamp>
  </target>
  
  <target name="set-installer.basename" unless="unstaller.basename" depends="set-buildnumber">
    <property name="installer.basename" value="NetBeans-dev-${buildnumber}"/>
  </target>
  
  <macrodef name="transform-ml">
    <attribute name="input.ismp.project"/>
    <sequential>
      <java classname="com.installshield.isje.ISJE" fork="true">
        <arg value="@{input.ismp.project}" />
        <arg value="-xsl" />
        <arg value="../lib/ml.xsl"/>
        <arg value="-saveas"/>
        <arg value="@{input.ismp.project}-ml"/>
        <classpath>
          <path refid="ismp.cp"/>
        </classpath>
      </java>
    </sequential>
  </macrodef>
  
  <target name="xsl-linux-ml" depends="init">
    <transform-ml input.ismp.project="linux.xml"/>
  </target>
  
  <target name="xsl-solaris-sparc-ml" depends="init">
    <transform-ml input.ismp.project="solaris-sparc.xml"/>
  </target>
  
  <target name="xsl-solaris-x86-ml" depends="init">
    <transform-ml input.ismp.project="solaris-x86.xml"/>
  </target>
  
  <target name="xsl-windows-ml" depends="init">
    <transform-ml input.ismp.project="windows.xml"/>
  </target>
  
  <macrodef name="build-installer">
    <attribute name="input.ismp.project"/>
    <sequential>
      <java classname="com.installshield.isje.ISJE" fork="true">
        <arg value="@{input.ismp.project}"/>
        <arg value="-build"/>
        <arg value="-alias"/>
        <arg value="basedir=${basedir}"/>
        <arg value="-alias"/>
        <arg value="nb.dir=${nb.dir}"/>
        <arg value="-alias"/>
        <arg value="jdk.installer=${jdk.installer}"/>
        <arg value="-alias"/>
        <arg value="jdk.scripts.dir=build/scripts"/>
        <arg value="-alias"/>
        <arg value="bundled.jvm=${bundled.jvm}"/>
        <arg value="-alias"/>
        <arg value="storage.builder=${storage.builder}"/>
        <arg value="-alias"/>
        <arg value="sb.scripts.dir=build/storagebuilder"/>
        <classpath>
          <pathelement path="build/classes"/>
          <path refid="ismp.cp"/>
        </classpath>
      </java>
    </sequential>
  </macrodef>
  
  <target name="build-linux" depends="init, compile">
    <copy file="scripts/j2se-install.template" tofile="build/scripts/_uninst/j2se-install.template"/>
    <copy file="scripts/j2se-uninstall.template" tofile="build/scripts/_uninst/j2se-uninstall.template"/>
    <copy file="${preparse.files}"
          tofile="build/storagebuilder/preparse-files.txt"/>
    <build-installer input.ismp.project="linux.xml"/>
    <delete dir="build/scripts"/>
    <delete dir="build/storagebuilder"/>
    <move file="build/disk1/setuplinux.bin" tofile="dist/${installer.basename}-linux.bin"/>
  </target>
  
  <target name="build-linux-ml" depends="init-ml, compile, xsl-linux-ml">
    <copy file="scripts/j2se-install.template" tofile="build/scripts/_uninst/j2se-install.template"/>
    <copy file="scripts/j2se-uninstall.template" tofile="build/scripts/_uninst/j2se-uninstall.template"/>
    <copy file="${preparse.files}"
          tofile="build/storagebuilder/preparse-files.txt"/>
    <build-installer input.ismp.project="linux.xml-ml"/>
    <delete dir="build/scripts"/>
    <delete dir="build/storagebuilder"/>
    <move file="build/disk1/setuplinux.bin" tofile="dist/${installer.basename}-linux-ml.bin"/>
    <delete file="linux.xml-ml"/>
  </target>

  <target name="build-solaris-sparc" depends="init, compile">
    <copy file="scripts/j2se-install.template" tofile="build/scripts/_uninst/j2se-install.template"/>
    <copy file="scripts/j2se-uninstall.template" tofile="build/scripts/_uninst/j2se-uninstall.template"/>
    <copy file="${preparse.files}"
          tofile="build/storagebuilder/preparse-files.txt"/>
    <build-installer input.ismp.project="solaris-sparc.xml"/>
    <delete dir="build/scripts"/>
    <delete dir="build/storagebuilder"/>
    <move file="build/disk1/setupSolarisSparc.bin" tofile="dist/${installer.basename}-solsparc.bin"/>
  </target>
  
  <target name="build-solaris-sparc-ml" depends="init-ml, compile, xsl-solaris-sparc-ml">
    <copy file="scripts/j2se-install.template" tofile="build/scripts/_uninst/j2se-install.template"/>
    <copy file="scripts/j2se-uninstall.template" tofile="build/scripts/_uninst/j2se-uninstall.template"/>
    <copy file="${preparse.files}"
          tofile="build/storagebuilder/preparse-files.txt"/>
    <build-installer input.ismp.project="solaris-sparc.xml-ml"/>
    <delete dir="build/scripts"/>
    <delete dir="build/storagebuilder"/>
    <move file="build/disk1/setupSolarisSparc.bin" tofile="dist/${installer.basename}-solsparc-ml.bin"/>
    <delete file="solaris-sparc.xml-ml"/>
  </target>

  <target name="build-solaris-x86" depends="init, compile">
    <copy file="scripts/j2se-install.template" tofile="build/scripts/_uninst/j2se-install.template"/>
    <copy file="scripts/j2se-uninstall.template" tofile="build/scripts/_uninst/j2se-uninstall.template"/>
    <copy file="${preparse.files}"
          tofile="build/storagebuilder/preparse-files.txt"/>
    <build-installer input.ismp.project="solaris-x86.xml"/>
    <delete dir="build/scripts"/>
    <delete dir="build/storagebuilder"/>
    <move file="build/disk1/setupSolarisX86.bin" tofile="dist/${installer.basename}-solx86.bin"/>
  </target>
  
  <target name="build-solaris-x86-ml" depends="init-ml, compile, xsl-solaris-x86-ml">
    <copy file="scripts/j2se-install.template" tofile="build/scripts/_uninst/j2se-install.template"/>
    <copy file="scripts/j2se-uninstall.template" tofile="build/scripts/_uninst/j2se-uninstall.template"/>
    <copy file="${preparse.files}"
          tofile="build/storagebuilder/preparse-files.txt"/>
    <build-installer input.ismp.project="solaris-x86.xml-ml"/>
    <delete dir="build/scripts"/>
    <delete dir="build/storagebuilder"/>
    <move file="build/disk1/setupSolarisX86.bin" tofile="dist/${installer.basename}-solx86-ml.bin"/>
    <delete file="solaris-x86.xml-ml"/>
  </target>

  <target name="build-windows" depends="init, compile">
    <copy file="scripts/custom-install-jdk.template" tofile="build/scripts/_uninst/custom-install-jdk.template"/>
    <copy file="scripts/custom-install-jre.template" tofile="build/scripts/_uninst/custom-install-jre.template"/>
    <copy file="${preparse.files}"
          tofile="build/storagebuilder/preparse-files.txt"/>
    <build-installer input.ismp.project="windows.xml"/>
    <delete dir="build/scripts"/>
    <delete dir="build/storagebuilder"/>
    <move file="build/disk1/setupwin32.exe" tofile="dist/${installer.basename}-win.exe"/>
  </target>
  
  <target name="build-windows-ml" depends="init-ml, compile, xsl-windows-ml">
    <copy file="scripts/custom-install-jdk.template" tofile="build/scripts/_uninst/custom-install-jdk.template"/>
    <copy file="scripts/custom-install-jre.template" tofile="build/scripts/_uninst/custom-install-jre.template"/>
    <copy file="${preparse.files}"
          tofile="build/storagebuilder/preparse-files.txt"/>
    <build-installer input.ismp.project="windows.xml-ml"/>
    <delete dir="build/scripts"/>
    <delete dir="build/storagebuilder"/>
    <move file="build/disk1/setupwin32.exe" tofile="dist/${installer.basename}-win-ml.exe"/>
    <delete file="windows.xml-ml"/>
  </target>
 
  <target name="compile" depends="init, build-library" description="compile custom beans and panels">
    <mkdir dir="build/classes"/>
    
    <javac destdir="build/classes" srcdir="src" source="1.4" target="1.4" debug="true" deprecation="true">
      <classpath>
        <path refid="ismp.cp"/>
      </classpath>
    </javac>
    <copy todir="build/classes">
        <fileset dir="src">
            <include name="**/*.properties"/>
        </fileset>
    </copy>
  </target>
 
  <!-- Build library -->
  <target name="build-library" description="compile shared library">
    <ant antfile="../lib/build.xml" target="jar" inheritAll="false"/>
  </target>

  <!-- Clean library -->
  <target name="clean-library" description="clean shared library">
    <ant antfile="../lib/build.xml" target="clean" inheritAll="false"/>
  </target>

  <target name="run" depends="init" description="run the installer">
    <exec os="Windows NT Windows 95 Windows 98 Windows 2000 Windows XP" executable="${basedir}/dist/${installer.basename}-win.exe" failonerror="yes"/>
    <exec os="Linux"  executable="${basedir}/dist/${installer.basename}-linux.bin" failonerror="yes"/>
  </target>
    
  <target name="test" depends="init, compile" description="run the installer in debug mode">
    <java classname="run" fork="true">
      <sysproperty key="is.debug" value="true" />
      <classpath>
        <pathelement path="build/classes" />
        <pathelement path="dist/${installer.basename}.jar"/>
      </classpath>
    </java>
  </target>
  
  <target name="clean" depends="init, clean-library" description="Clean all build products and temp/backup files.">
    <delete>
      <fileset dir=".">
        <include name="**/*~"/>
      </fileset>
    </delete>
    <delete dir="dist"/>
    <delete dir="build"/>
  </target>
  
  <target name="ismp" depends="init, compile" description="launch ISMP IDE">
    <exec os="Linux" command="sh -c &quot;${ismp.home}/ismp &amp;&quot;" />
  </target>
  
</project>
