<?xml version="1.0" encoding="UTF-8"?>
<!--
                Sun Public License Notice

The contents of this file are subject to the Sun Public License
Version 1.0 (the "License"). You may not use this file except in
compliance with the License. A copy of the License is available at
http://www.sun.com/

The Original Code is NetBeans. The Initial Developer of the Original
Code is Nokia. Portions Copyright 2003 Nokia.
All Rights Reserved.
-->

<project basedir="." default="netbeans" name="jnlpinstaller">

    <property name="nb_all" value="../.."/>
    <property name="jnlp-api.file.location" value="../external/jnlp.jar"/>
    <property name="jnlp-servlet.file.location" value="../external/jnlp-servlet.jar"/>

    <target name="compile">
        <ant dir="../external"/>
        <javac debug="${build.compiler.debug}" deprecation="${build.compiler.deprecation}" destdir="src" srcdir="src">
            <classpath refid="cp"/>
        </javac>
    </target>

    <target depends="jnlp-expand1, create-war" name="netbeans">
    </target>

    <target depends="copy-to-release, create-jnlp-jars" name="create-config">
        <!-- This target creates the end of nb-launch.jnlp file -->
        <path id="jarfiles">
            <fileset dir="release">
                <include name="*.jar"/>
            </fileset>
        </path>
        <property location="${nb_all}/installer/jnlp/release/" name="dirname"/>
        <!-- save directory name for replacing back -->
        <replace file="release/nb-launch.jnlp" token="${dirname}" value="D#I#R#_#N#A#M#E"/>
        <pathconvert dirsep="${file.separator}" pathsep="" property="jar-files-list" refid="jarfiles"/>
        <echo append="true" file="release/nb-launch.jnlp" message="@@@${jar-files-list}%%%"/>
        <echo message="Replacing ${dirname}"/>
        <replace file="release/nb-launch.jnlp" token="${dirname}${file.separator}" value="@@@###"/>
        <replace file="release/nb-launch.jnlp" token="@@@@@@" value=""/>
        <replace file="release/nb-launch.jnlp" token="@@@">
            <replacevalue><![CDATA["/>
]]></replacevalue>
        </replace>
        <replace file="release/nb-launch.jnlp" token="%%%">
            <replacevalue><![CDATA["/>
]]></replacevalue>
        </replace>
        <replace file="release/nb-launch.jnlp" token="###">
            <replacevalue><![CDATA[        <jar href="]]></replacevalue>
        </replace>
        <echo append="true" file="release/nb-launch.jnlp" message="${jnlp.extra.properties}"/>
        <echo append="true" file="release/nb-launch.jnlp">
<![CDATA[        
    </resources>
    <application-desc main-class="org.netbeans.core.Main"/>
</jnlp>
]]></echo>
        <!-- replace back accidentally replaced name of the directory -->
        <replace file="release/nb-launch.jnlp" token="D#I#R#_#N#A#M#E" value="${dirname}${file.separator}"/>
    </target>
    
    <target depends="jars" name="copy-to-release">
        <mkdir dir="release"/>
        <copy flatten="true" todir="release">
            <fileset dir="">
                <include name="*.jnlp"/>
            </fileset>
        </copy>
    </target>
    
    <target name="jnlp-expand1" depends="create-config" if="jnlp.static">
        <replace file="release/nb-launch.jnlp" token="@CODEBASE@" value="${jnlp.codebase}"/>
        <replace file="release/nb-launch.jnlp" token="@NAME@" value="nb-launch.jnlp"/>
    </target>
    
    <target name="jnlp-expand2" depends="create-config" unless="jnlp.static">
        <replace file="release/nb-launch.jnlp" token="@CODEBASE@" value="$$$$codebase"/>
        <replace file="release/nb-launch.jnlp" token="@NAME@" value="$$$$name"/>
    </target>

    <target name="create-war" depends="jnlp-expand2" unless="jnlp.static">
        <mkdir dir="release/WEB-INF/lib"/>
        <copy file="${jnlp-servlet.file.location}" todir="release/WEB-INF/lib"/>
        <mkdir dir="release/WEB-INF/classes"/>
        <copy todir="release/WEB-INF/classes" flatten="false">
            <fileset dir="src" excludesfile="${nb_all}/nbbuild/standard-jar-excludes.txt">
                <include name="**/IndexServlet*"/>
            </fileset>
        </copy>
        <war basedir="release" 
            compress="false"
            webxml="web.xml"
            warfile="${netbeans.dest}.war"/>
    </target>
        
    <target depends="jars" name="create-jnlp-jars">
        <mkdir dir="release"/>
        <copy flatten="true" todir="release">
            <fileset dir="jars">
                <include name="**/*.jar"/>
            </fileset>
        </copy>
        <!-- now they can be signed -->
        <signjar alias="${jnlp.signjar.alias}" storepass="${jnlp.signjar.password}">
            <fileset dir=".">
                <include name="release/*.jar"/>
            </fileset>
        </signjar>
    </target>
    
    <target name="delete-release">
        <delete dir="release"/>
    </target>
    
    <target name="nbm"/>
    
    <target description="Clean build products." name="clean">
        <delete>
            <fileset dir="src">
                <include name="**/*.class"/>
            </fileset>
        </delete>
	<!-- workaround for issue 20745 -->
        <delete dir="netbeans/lib"/>
        <delete dir="Info"/>
        <delete file="manifest-subst.mf"/>
        <delete dir="javadoc"/>
        <delete dir="release"/>
        <delete dir="jars"/>
        <delete file="${netbeans.dest}.war"/>
    </target>

    <target depends="clean" name="real-clean">
        <delete dir="reload"/>
    </target>

    <path id="cp">
        <pathelement location="${nb_all}/core/netbeans/lib/ext/boot.jar"/>
        <pathelement location="${jnlp-api.file.location}"/>
        <pathelement location="${nb_all}/web/external/servlet-2.3.jar"/>
    </path>
    
    <target name="jars" depends="compile, delete-release">
        <taskdef name="repeat" classname="org.netbeans.nbbuild.Repeat" classpath="${nb_all}/nbbuild/nbantext.jar"/>
        
        <repeat values="${allmodules}" name="maindir" target="buildjar"/>
        <!-- if we use JDK 1.4 we no longer need these files: -->
        <delete file="jars/core/crimson-1.1.3.jar"/>
        <delete file="jars/core/regexp-1.2.jar"/>
        <delete file="jars/core/xml-apis-1.0b2.jar"/>
<!--        <delete file="jars/core/xerces-2.0.2.jar"/> -->
    </target>

    <target name="buildjar">
        <echo message="buildjar running with property maindir == ${maindir}"/>
        
        <mkdir dir="jars/${maindir}"/>
        
        <fileset dir="../../${maindir}" id="modules">
            <include name="netbeans/modules/*.jar"/>
        </fileset>
        
        <fileset dir="../../${maindir}" id="modules-ext">
            <include name="netbeans/modules/ext/*.jar"/>
        </fileset>
        
        <fileset dir="../../${maindir}" id="modules-autoload">
            <include name="netbeans/modules/autoload/*.jar"/>
        </fileset>
        
        <fileset dir="../../${maindir}" id="modules-autoload-ext">
            <include name="netbeans/modules/autoload/ext/*.jar"/>
        </fileset>
        
        <fileset dir="../../${maindir}" id="modules-eager">
            <include name="netbeans/modules/eager/*.jar"/>
        </fileset>
        
        <fileset dir="../../${maindir}" id="modules-eager-ext">
            <include name="netbeans/modules/eager/ext/*.jar"/>
        </fileset>
        
        <copy flatten="true" todir="jars/${maindir}">
            <fileset dir="../../${maindir}" id="without-repackaging">
                <include name="netbeans/lib/**/*.jar"/>
            </fileset>
        </copy>

        <pathconvert pathsep="," property="f1" refid="modules" setonempty="false"/>
        <antcall target="repackage-all">
            <param name="subdir" value="modules"/>
            <param name="forconversion" value="${f1}"/>
        </antcall>
        
        <pathconvert pathsep="," property="f2" refid="modules-ext" setonempty="false"/>
        <antcall target="repackage-all">
            <param name="subdir" value="modules/ext"/>
            <param name="forconversion" value="${f2}"/>
        </antcall>
        
        <pathconvert pathsep="," property="f3" refid="modules-autoload" setonempty="false"/>
        <antcall target="repackage-all">
            <param name="subdir" value="modules/autoload"/>
            <param name="forconversion" value="${f3}"/>
        </antcall>
        
        <pathconvert pathsep="," property="f4" refid="modules-autoload-ext" setonempty="false"/>
        <antcall target="repackage-all">
            <param name="subdir" value="modules/autoload/ext"/>
            <param name="forconversion" value="${f4}"/>
        </antcall>
        
        <pathconvert pathsep="," property="f5" refid="modules-eager" setonempty="false"/>
        <antcall target="repackage-all">
            <param name="subdir" value="modules/eager"/>
            <param name="forconversion" value="${f5}"/>
        </antcall>
        
        <pathconvert pathsep="," property="f6" refid="modules-eager-ext" setonempty="false"/>
        <antcall target="repackage-all">
            <param name="subdir" value="modules/eager/ext"/>
            <param name="forconversion" value="${f6}"/>
        </antcall>
    </target>
    
    <target name="repackage-all">
        <condition property="run-repackage">
            <not>
                <!-- This a little trick to find out whether property
                    forconversion contains real set of path or one of
                    the strings ${f1} .. ${f6}. It contains this strange
                    string in case the folder for conversion is emtpy.
                    Sorry I did not find any better way to decide whether
                    a property is empty - it would reuire a dedicated task.
                -->
                <contains string="${forconversion}" substring="{f"/>
            </not>
        </condition>
        <antcall target="repackage-all2"/>
    </target>
    
    <target name="repackage-all2" if="run-repackage">
        <echo message="repackage-all called with --${forconversion}--"/>
        <repeat values="${forconversion}" name="filetoconvert" target="repackage"/>
    </target>
    
    <target name="repackage">
        <echo message="Trying to repackage ${filetoconvert}"/>
        <basename property="fname" file="${filetoconvert}" suffix=".jar"/>
        <basename property="fullname" file="${filetoconvert}"/>
    
        <mkdir dir="jars/${maindir}/tmp/${fname}"/>
        <unjar src="${filetoconvert}" dest="jars/${maindir}/tmp/${fname}"/>
        <echo file="jars/${maindir}/${fname}-manifest.mf"><![CDATA[Manifest-Version: 1.0
NetBeans-Location: ${subdir}
NetBeans-Prefix: ${fname}

]]></echo>
        <jar jarfile="jars/${maindir}/${fname}.jar" 
             basedir="jars/${maindir}/tmp"
             manifest="jars/${maindir}/${fname}-manifest.mf"
        />
        <delete dir="jars/${maindir}/tmp"/>
    </target>
</project>

