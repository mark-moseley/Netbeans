<?xml version="1.0" encoding="UTF-8"?>
<!--
  The contents of this file are subject to the terms of the Common Development and
  Distribution License (the License). You may not use this file except in compliance
  with the License.
  
  You can obtain a copy of the License at http://www.netbeans.org/cddl.html or
  http://www.netbeans.org/cddl.txt.
  
  When distributing Covered Code, include this CDDL Header Notice in each file and
  include the License file at http://www.netbeans.org/cddl.txt. If applicable, add
  the following below the CDDL Header, with the fields enclosed by brackets []
  replaced by your own identifying information:
  
      "Portions Copyrighted [year] [name of copyright owner]"
  
  The Original Software is NetBeans. The Initial Developer of the Original Software
  is Sun Microsystems, Inc. Portions Copyright 1997-2007 Sun Microsystems, Inc. All
  Rights Reserved.
-->

<project name="bootstrap" default="all" basedir=".">
    <property file="${basedir}/build.properties"/>
    
    <target name="build" depends="init,-build"/>
    
    <target name="init" depends="-clean,-checkout-trunk,-checkout-branch,-init,-init-properties,-post-init-clean"/>
    
    <target name="-clean">
        <delete dir="${output.dir}"/>
        <delete dir="${nbi.all.dir}"/>
    </target>
    
    <target name="-checkout-trunk" unless="cvs.branch">
        <!-- -->
        <cvs 
            command="checkout -P"
            cvsroot="${cvs.root}" 
            package="nbi"
            dest="${nbi.all.dir}"
            failonerror="true"
        />
        <cvs 
            command="checkout -P"
            cvsroot="${cvs.root}" 
            package="installer/components installer/engine installer/infra"
            dest="${nbi.all.dir}"
            failonerror="true"
        />
        <!-- -->
        
        <!--
        <copy todir="${nbi.core.dir}">
            <fileset dir="D:/work/nbi">
                <exclude name="infra/server/**/build/**/*.*"/>
                <exclude name="infra/server/**/dist/**/*.*"/>
                <exclude name="infra/server/**/private/**/*.*"/>
            </fileset>
        </copy>
        <copy todir="${nbi.netbeans.dir}">
            <fileset dir="D:/work/installer">
                <exclude name="infra/server/**/build/**/*.*"/>
                <exclude name="infra/server/**/dist/**/*.*"/>
                <exclude name="infra/server/**/private/**/*.*"/>
            </fileset>
        </copy>
        -->
    </target>
    
    <target name="-checkout-branch" if="cvs.branch">
        <cvs 
            command="checkout -P"
            cvsroot="${cvs.root}" 
            tag="${cvs.branch}"
            package="nbi"
            dest="${nbi.all.dir}"
            failonerror="true"
        />
        <cvs 
            command="checkout -P"
            cvsroot="${cvs.root}" 
            tag="${cvs.branch}"
            package="installer/components installer/engine installer/infra"
            dest="${nbi.all.dir}"
            failonerror="true"
        />
    </target>
    
    <target name="-init">
        <delete dir="${custom.tasks.cls}"/>
        <mkdir dir="${custom.tasks.cls}"/>
        
        <!-- first we need to perform an "unofficial" build of the engine in order 
             to ensure it's available in the classpath for the custom ant tasks -->
        <subant buildpath="${nbi.core.dir}/engine" 
                target="compile" 
                failonerror="true" 
                output="core.engine.unofficial.build.output">
            <property name="platforms.JDK_1.5.home" value="${jdk.home}"/>
            <property name="basedir" value="${nbi.core.dir}/engine"/>
        </subant>
        <copy todir="${custom.tasks.cls}">
            <fileset dir="${nbi.core.dir}/engine/build/classes">
                <include name="**/*.*"/>
            </fileset>
        </copy>
        
        <!-- second we compile the required custom libraries -->
        <javac 
            srcdir="${nbi.core.dir}/infra/lib/registries-management" 
            destdir="${custom.tasks.cls}"
            classpath="${custom.tasks.cls}"
            debug="true"/>
        
        <!-- then compile all the custom ant tasks -->
        <javac 
            srcdir="${custom.tasks.src.1}" 
            destdir="${custom.tasks.cls}"
            classpath="${custom.tasks.cls}"
            debug="true"/>
        <javac 
            srcdir="${custom.tasks.src.2}" 
            destdir="${custom.tasks.cls}"
            classpath="${custom.tasks.cls}"
            debug="true"/>
        <javac 
            srcdir="${custom.tasks.src.3}" 
            destdir="${custom.tasks.cls}"
            classpath="${custom.tasks.cls}"
            debug="true"/>
        
        <taskdef 
            name="glassfish-buildnumber" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.BuildNumberGlassFish"/>
        <taskdef 
            name="openesb-buildnumber" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.BuildNumberOpenEsb"/>
        <taskdef 
            name="sjsam-buildnumber" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.BuildNumberSjsam"/>
        <taskdef 
            name="swdp-buildnumber" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.BuildNumberSwdp"/>
        <taskdef 
            name="portletcontainer-buildnumber" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.BuildNumberPortletContainer"/>
        <taskdef 
            name="javaeesdk-firstcup-buildnumber" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.BuildNumberFirstCup"/>
        <taskdef 
            name="javaeesdk-blueprints-buildnumber" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.BuildNumberBluePrints"/>
        
        <taskdef 
            name="if" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.If"/>
        <taskdef 
            name="set" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.SetProperty"/>
        <taskdef 
            name="export-registry" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.registries.ExportRegistry"/>
        <taskdef 
            name="generate-components-js" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.registries.GenerateComponentsJs"/>
        <taskdef 
            name="create-bundle" 
            classpath="${custom.tasks.cls}" 
            classname="org.netbeans.installer.infra.build.ant.registries.CreateBundle"/>
        
        <!--
        <get
            src="${glassfish.builds.host}/java/re/glassfish/9.1/promoted/rc/b51/bundles/"
            dest="${temp.file}"/>
        -->
        <get
            src="${glassfish.builds.host}/java/re/glassfish/9.1/promoted/rc1/latest/bundles/"
            dest="${temp.file}"/>
        <glassfish-buildnumber 
            file="${temp.file}" 
            prefix="glassfish"/>
        <glassfish-buildnumber 
            file="${temp.file}" 
            prefix="sjsas"/>

        <get
            src="${openesb.builds.host}/kits/ojc/openesb_as9_fcs/latestSDK/log/"
            dest="${temp.file}"/>
        <openesb-buildnumber 
            file="${temp.file}" 
            prefix="openesb"/>
        
        <get
            src="${glassfish.builds.host}/java/re/swdp/1.0/promoted/fcs/latest/bundles/"
            dest="${temp.file}"/>
        <swdp-buildnumber 
            file="${temp.file}" 
            prefix="swdp"/>
        
        <get
            src="${glassfish.builds.host}/java/re/javaeesdk/5.0_03/archive/preview2/latest/bundles/"
            dest="${temp.file}"/>
        <portletcontainer-buildnumber 
            file="${temp.file}" 
            prefix="portletcontainer"/>
        <javaeesdk-firstcup-buildnumber 
            file="${temp.file}" 
            prefix="javaeesdk-firstcup"/>
        <javaeesdk-blueprints-buildnumber 
            file="${temp.file}" 
            prefix="javaeesdk-blueprints"/>
        <javaeesdk-blueprints-buildnumber 
            file="${temp.file}" 
            prefix="javaeesdk-samples"/>
        
        <property name="javaeesdk-javadocs.build.number" value="20060907"/>
        
        <!--
        <get
            src="${sjsam.builds.host}/projects/am-javaee/update3beta/"
            dest="${temp.file}"/>
        -->
        <get
            src="${glassfish.builds.host}/java/re/javaeesdk/5.0_03/archive/fcs/latest/bundles/"
            dest="${temp.file}"/>
        <sjsam-buildnumber 
            file="${temp.file}" 
            prefix="sjsam"/>
            
        <!--
        <property name="sjsam.milestone.number" value="1"/>
        <property name="sjsam.build.number" value="20070614"/>
        -->
        
        <delete file="${temp.file}"/>
    </target>
    
    <target name="-init-properties">
        <echo file="${environment.properties}"/>
        
        <if property="cvs.branch">
            <echo file="${environment.properties}" append="true">
cvs.branch=${cvs.branch}

            </echo>
        </if>
        <echo file="${environment.properties}" append="true">
cvs.root=${cvs.root}
cvs.module=installer

checkout.sources=false
sources.dir=${nbi.all.dir}

release.to.server=false
release.registry.dir=${output.dir}/registry-temp

build.number=${build.number}

glassfish.milestone.number=${glassfish.milestone.number}
glassfish.milestone.number.real=${glassfish.milestone.number.real}
glassfish.build.type=${glassfish.build.type}
glassfish.build.number=${glassfish.build.number}

sjsas.milestone.number=${sjsas.milestone.number}
sjsas.milestone.number.real=${sjsas.milestone.number.real}
sjsas.build.type=${sjsas.build.type}
sjsas.build.number=${sjsas.build.number}

openesb.build.number=${openesb.build.number}
openesb.build.number.real=${openesb.build.number.real}

sjsam.milestone.number=${sjsam.milestone.number}
sjsam.build.number=${sjsam.build.number}

swdp.milestone.number=${swdp.milestone.number}
swdp.build.type=${swdp.build.type}
swdp.build.number=${swdp.build.number}
swdp.macro.number=${swdp.macro.number}

portletcontainer.milestone.number=${portletcontainer.milestone.number}
portletcontainer.build.number=${portletcontainer.build.number}
portletcontainer.macro.number=${portletcontainer.macro.number}
portletcontainer.micro.number=${portletcontainer.micro.number}

javaeesdk-firstcup.milestone.number=${javaeesdk-firstcup.milestone.number}
javaeesdk-firstcup.build.number=${javaeesdk-firstcup.build.number}
javaeesdk-firstcup.macro.number=${javaeesdk-firstcup.macro.number}
javaeesdk-firstcup.micro.number=${javaeesdk-firstcup.micro.number}


javaeesdk-blueprints.milestone.number=${javaeesdk-blueprints.milestone.number}
javaeesdk-blueprints.build.number=${javaeesdk-blueprints.build.number}

javaeesdk-samples.milestone.number=${javaeesdk-samples.milestone.number}
javaeesdk-samples.build.number=${javaeesdk-samples.build.number}
javaeesdk-javadocs.build.number=${javaeesdk-javadocs.build.number}

dont.build.custom.tasks=true
custom.tasks.cls=${custom.tasks.cls}

build.engine=false

engine.dist.file.name=nbi-engine.jar
engine.dist.file=${nbi.netbeans.dir}/infra/build/engine/dist/nbi-engine.jar

release.url=http://${glassfish.host}:${glassfish.http.port}${context.path}/admin
release.registry=NetBeans

packaged.data.dir=${basedir}/cache/packaged
downloads.cache.dir=${basedir}/cache/raw

binary.cache.host=${binary.cache.host}
nb.builds.host=${nb.builds.host}
glassfish.builds.host=${glassfish.builds.host}
openesb.builds.host=${openesb.builds.host}
sjsam.builds.host=${sjsam.builds.host}

remote.work.dir=~/.netbeans-trunk-nightly-${build.number}

remote.host.windows=${remote.host.windows}
remote.port.windows=${remote.port.windows}
remote.user.windows=${remote.user.windows}

remote.host.linux=${remote.host.linux}
remote.port.linux=${remote.port.linux}
remote.user.linux=${remote.user.linux}

remote.host.solaris-x86=${remote.host.solaris-x86}
remote.port.solaris-x86=${remote.port.solaris-x86}
remote.user.solaris-x86=${remote.user.solaris-x86}

remote.host.solaris-sparc=${remote.host.solaris-sparc}
remote.port.solaris-sparc=${remote.port.solaris-sparc}
remote.user.solaris-sparc=${remote.user.solaris-sparc}

remote.host.macosx=${remote.host.macosx}
remote.port.macosx=${remote.port.macosx}
remote.user.macosx=${remote.user.macosx}

sjsas.image.token.hostname.windows=${sjsas.image.token.hostname.windows}
sjsas.image.token.hostname.linux=${sjsas.image.token.hostname.linux}
sjsas.image.token.hostname.solaris-x86=${sjsas.image.token.hostname.solaris-x86}
sjsas.image.token.hostname.solaris-sparc=${sjsas.image.token.hostname.solaris-sparc}
sjsas.image.token.hostname.macosx=${sjsas.image.token.hostname.macosx}
        </echo>
	<if property="jarsigner.enabled" value="true">
	    <echo file="${environment.properties}" append="true">
jarsigner.keystore=${jarsigner.keystore}
jarsigner.alias=${jarsigner.alias}
jarsigner.storepass=${jarsigner.storepass}
            </echo>
	</if>
        <replace file="${environment.properties}" token="\" value="/"/>
    </target>
    
    <target name="-post-init-clean">
        <delete dir="${basedir}/cache/raw"/>
        <delete>
            <fileset dir="${basedir}/cache/packaged">
                <!-- nb components -->
                <exclude name="**/nb*${build.number}*"/>
                
                <!-- glassfish -->
                <exclude name="**/glassfish*${glassfish.milestone.number}.${glassfish.build.number}*"/>
                
                <!-- openesb -->
                <exclude name="**/openesb*${glassfish.milestone.number}.${openesb.build.number}*"/>
                
                <!-- sjsam -->
                <exclude name="**/sjsam*${glassfish.milestone.number}.${sjsam.build.number}*"/>
                
                <!-- tomcat -->
                <exclude name="**/tomcat*"/>
            </fileset>
        </delete>
    </target>
    
    <target name="-build">
        <delete dir="${output.dir}"/>
        
        <mkdir dir="${output.dir}"/>
        <mkdir dir="${output.dir}/bundles"/>
        <mkdir dir="${output.dir}/components"/>
        <mkdir dir="${output.dir}/img"/>
        <mkdir dir="${output.dir}/js"/>
        <mkdir dir="${output.dir}/css"/>
        
        <property name="engine.dist.file.name" value="nbi-engine.jar"/>
        
        <echo message="BUILDING CORE ENGINE ======================================"/>
        <ant dir="${nbi.core.dir}/infra/build/engine" target="build-all">
            <property 
                name="basedir" 
                value="${nbi.core.dir}/infra/build/engine"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="build.native"
                value="false"/>
            <property 
                name="cvs.module" 
                value="${core.module.name}"/>
        </ant>
        
        <echo message="BUILDING NETBEANS ENGINE =================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/engine" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/engine"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property 
                name="core.engine.dist.file" 
                value="${nbi.core.dir}/infra/build/engine/dist/${engine.dist.file.name}"/>
        </ant>
        
        <echo message="BUILDING NB-IDE-GROUP ====================================="/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/groups/nb-ide-group" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/groups/nb-ide-group"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->
        
        <echo message="BUILDING NB-BASE =========================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/nb-base" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/nb-base"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING NB-JAVASE ========================================"/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/nb-javase" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/nb-javase"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING NB-ADDONS-GROUP =================================="/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/groups/nb-addons-group" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/groups/nb-addons-group"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="release.parent.uid"
                value="nb-ide-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->
        
        <echo message="BUILDING NB-JAVA-EE ======================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/nb-javaee" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/nb-javaee"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING NB-JAVA-ME ======================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/nb-javame" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/nb-javame"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING NB-SOA ==========================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/nb-soa" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/nb-soa"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING NB-UML ==========================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/nb-uml" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/nb-uml"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING NB-RUBY =========================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/nb-ruby" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/nb-ruby"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING RUNTIMES-GROUP ==================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/groups/runtimes-group" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/groups/runtimes-group"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="release.parent.uid"
                value=""/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING GLASSFISH ========================================"/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/glassfish" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/glassfish"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
                
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING SJSAS ============================================"/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/products/sjsas" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/sjsas"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->
        
        <echo message="BUILDING TOMCAT ==========================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/tomcat" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/tomcat"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING OPENESB =========================================="/>
        <ant dir="${nbi.netbeans.dir}/infra/build/products/openesb" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/openesb"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        
        <echo message="BUILDING SJSAM ============================================"/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/products/sjsam" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/sjsam"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
            
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->
        
        <echo message="BUILDING SWDP ============================================="/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/products/swdp" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/swdp"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
                
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->
        
        <echo message="BUILDING PORTLET CONTAINER ================================"/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/products/portletcontainer" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/portletcontainer"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
                
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->
        
        <echo message="BUILDING JAVAEESDK: FIRSTCUP =============================="/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/products/javaeesdk-firstcup" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/javaeesdk-firstcup"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
                
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->

        <echo message="BUILDING JAVAEESDK: BLUEPRINTS ============================"/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/products/javaeesdk-blueprints" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/javaeesdk-blueprints"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
                
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->

        <echo message="BUILDING JAVAEESDK: SAMPLES ==============================="/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/products/javaeesdk-samples" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/javaeesdk-samples"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
                
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->
        
        <echo message="BUILDING JAVAEESDK: JAVADOCS =============================="/>
        <!--
        <ant dir="${nbi.netbeans.dir}/infra/build/products/javaeesdk-javadocs" target="release-all">
            <property 
                name="basedir" 
                value="${nbi.netbeans.dir}/infra/build/products/javaeesdk-javadocs"/>
            <property 
                name="environment.properties" 
                value="${environment.properties}"/>
            
            <property
                name="dist.dir"
                value="${output.dir}/components"/>
                
            <property
                name="release.parent.uid"
                value="runtimes-group"/>
            <property
                name="release.parent.version"
                value=""/>
            <property
                name="release.parent.platforms"
                value=""/>
        </ant>
        -->
        
        <export-registry 
            root="${output.dir}/registry-temp" 
            destination="${output.dir}/registry" 
            codebase="http://bits.netbeans.org/download/6.0/nightly/${build.number}/installers/registry"/>
        
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="windows" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-windows.exe">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="linux" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-linux.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="solaris-x86" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-solaris-x86.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="solaris-sparc" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-solaris-sparc.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="macosx-x86" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-macosx-x86.zip">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="macosx-ppc" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-macosx-ppc.zip">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
        </create-bundle>
        
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="windows" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-windows.exe">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javame" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="linux" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-linux.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javame" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="solaris-x86" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-solaris-x86.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="solaris-sparc" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-solaris-sparc.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="macosx-x86" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-macosx-x86.zip">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="macosx-ppc" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-macosx-ppc.zip">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
        </create-bundle>
        
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="windows" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-windows.exe">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javame" version="6.0.0.0.${build.number}"/>
            <component uid="nb-soa" version="6.0.0.0.${build.number}"/>
            <component uid="nb-uml" version="6.0.0.0.${build.number}"/>
            <component uid="nb-ruby" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
            <component uid="openesb" version="5.0.3.${glassfish.milestone.number}.${openesb.build.number}"/>
            <!--
            <component uid="sjsam" version="5.0.3.${glassfish.milestone.number}.${sjsam.build.number}"/>
            -->
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="linux" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-linux.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javame" version="6.0.0.0.${build.number}"/>
            <component uid="nb-soa" version="6.0.0.0.${build.number}"/>
            <component uid="nb-uml" version="6.0.0.0.${build.number}"/>
            <component uid="nb-ruby" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
            <component uid="openesb" version="5.0.3.${glassfish.milestone.number}.${openesb.build.number}"/>
            <!--
            <component uid="sjsam" version="5.0.3.${glassfish.milestone.number}.${sjsam.build.number}"/>
            -->
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="solaris-x86" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-solaris-x86.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="nb-soa" version="6.0.0.0.${build.number}"/>
            <component uid="nb-uml" version="6.0.0.0.${build.number}"/>
            <component uid="nb-ruby" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
            <component uid="openesb" version="5.0.3.${glassfish.milestone.number}.${openesb.build.number}"/>
            <!--
            <component uid="sjsam" version="5.0.3.${glassfish.milestone.number}.${sjsam.build.number}"/>
            -->
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="solaris-sparc" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-solaris-sparc.sh">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="nb-soa" version="6.0.0.0.${build.number}"/>
            <component uid="nb-uml" version="6.0.0.0.${build.number}"/>
            <component uid="nb-ruby" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
            <component uid="openesb" version="5.0.3.${glassfish.milestone.number}.${openesb.build.number}"/>
            <!--
            <component uid="sjsam" version="5.0.3.${glassfish.milestone.number}.${sjsam.build.number}"/>
            -->
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="macosx-x86" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-macosx-x86.zip">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="nb-soa" version="6.0.0.0.${build.number}"/>
            <!--<component uid="nb-uml" version="6.0.0.0.${build.number}"/>-->
            <component uid="nb-ruby" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
            <component uid="openesb" version="5.0.3.${glassfish.milestone.number}.${openesb.build.number}"/>
            <!--
            <component uid="sjsam" version="5.0.3.${glassfish.milestone.number}.${sjsam.build.number}"/>
            -->
        </create-bundle>
        <create-bundle root="${output.dir}/registry-temp" 
                       platform="macosx-ppc" 
                       target="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-macosx-ppc.zip">
            <component uid="nb-base" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javase" version="6.0.0.0.${build.number}"/>
            <component uid="nb-javaee" version="6.0.0.0.${build.number}"/>
            <component uid="nb-soa" version="6.0.0.0.${build.number}"/>
            <!--<component uid="nb-uml" version="6.0.0.0.${build.number}"/>-->
            <component uid="nb-ruby" version="6.0.0.0.${build.number}"/>
            <component uid="glassfish" version="2.0.0.${glassfish.milestone.number}.${glassfish.build.number}"/>
            <component uid="tomcat" version="6.0.13.0.0"/>
            <component uid="openesb" version="5.0.3.${glassfish.milestone.number}.${openesb.build.number}"/>
            <!--
            <component uid="sjsam" version="5.0.3.${glassfish.milestone.number}.${sjsam.build.number}"/>
            -->
        </create-bundle>

        <antcall target="zip-to-tgz">
            <param name="input.file"  value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-macosx-x86.zip"/>
            <param name="output.file" value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-macosx-x86.tgz"/>
        </antcall>
        <antcall target="zip-to-tgz">
            <param name="input.file"  value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-macosx-ppc.zip"/>
            <param name="output.file" value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-basic-macosx-ppc.tgz"/>
        </antcall>
	<antcall target="zip-to-tgz">
            <param name="input.file"  value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-macosx-x86.zip"/>
            <param name="output.file" value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-macosx-x86.tgz"/>
        </antcall>
        <antcall target="zip-to-tgz">
            <param name="input.file"  value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-macosx-ppc.zip"/>
            <param name="output.file" value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-standard-macosx-ppc.tgz"/>
        </antcall>
        <antcall target="zip-to-tgz">
            <param name="input.file"  value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-macosx-x86.zip"/>
            <param name="output.file" value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-macosx-x86.tgz"/>
        </antcall>
        <antcall target="zip-to-tgz">
            <param name="input.file"  value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-macosx-ppc.zip"/>
            <param name="output.file" value="${output.dir}/bundles/netbeans-6.0-nightly-${build.number}-full-macosx-ppc.tgz"/>
        </antcall>

       
        <replace 
            dir="${nbi.netbeans.dir}/infra/build/web" 
            token="${build.number.token}" 
            value="${build.number.replacement}"/>
        <copy todir="${output.dir}">
            <fileset dir="${nbi.netbeans.dir}/infra/build/web">
                <include name="**/*.*"/>
            </fileset>
        </copy>

        <generate-components-js 
            root="${output.dir}/registry-temp" 
            file="${output.dir}/js/components.js"/>        

        
        <delete dir="${output.dir}/registry-temp"/>
        
        <delete>
            <fileset dir="${output.dir}/bundles">
                <include name="*.command"/>
		<include name="*macos*zip"/>
            </fileset>
        </delete>
    </target>

    <target name="zip-to-tgz">
	<set property="tar.tmpdir"
             value="${output.dir}/bundles/tempdir"/>

	<mkdir dir="${tar.tmpdir}"/>

	<unzip 
		src="${input.file}"
		dest="${tar.tmpdir}"/>

        <tar tarfile="${output.file}" 
             compression="gzip">
            <tarfileset dir="${tar.tmpdir}" mode="644">
                <include name="**/*.*"/>
		<exclude name="**/executable"/>
            </tarfileset>
	    <tarfileset dir="${tar.tmpdir}" mode="755">
		<include name="**/executable"/>
            </tarfileset>
        </tar>
	<delete dir="${tar.tmpdir}"/>
    </target>
    <target name="zip-to-dmg"> 
	<antcall target="zip-to-tgz">
            <param name="input.file"  value="${zip.file}"/>
            <param name="output.file" value="${zip.file}.tgz"/>
        </antcall>
	<antcall target="tgz-to-dmg">
            <param name="tgz.file"  value="${zip.file}.tgz"/>
            <param name="dmg.file" value="${dmg.file}"/>
        </antcall>
	<delete file="${zip.file}.tgz"/>
    </target>

    <target name="tgz-to-dmg">        
	<echo message="Creating directory structure at MacOS system"/>	
        <echo message=""/>

        <sshexec host="${makedmg.remote.host}"
                 username="${makedmg.remote.user}"
		 port="${makedmg.remote.port}"
                 command="mkdir -p ~/.nbi-build/src ~/.nbi-build/tmp ~/.nbi-build/dmg"
                 verbose="true"
                 trust="true"
                 keyfile="${makedmg.ssh.keyfile}"
                 passphrase="${makedmg.ssh.keypass}"/>

	<echo message=""/>
	<echo message="Copying file ${tgz.file} to the MacOS system"/>
	<scp keyfile="${makedmg.ssh.keyfile}"
             passphrase="${makedmg.ssh.keypass}"
             verbose="true"
             trust="true"
             remoteTofile="${makedmg.remote.user}@${makedmg.remote.host}:~/.nbi-build/src/temp.tgz"
	     file="${tgz.file}"/>

	<echo message=""/>
	<echo message="Untar archive to temporary directory"/>

	<sshexec host="${makedmg.remote.host}"
                 username="${makedmg.remote.user}"
		 port="${makedmg.remote.port}"
                 command="cd ~/.nbi-build/tmp; tar -xzvf ~/.nbi-build/src/temp.tgz; rm -rf ~/.nbi-build/src"
                 verbose="true"
                 trust="true"
                 keyfile="${makedmg.ssh.keyfile}"
                 passphrase="${makedmg.ssh.keypass}"/>

	<echo message=""/>
	<echo message="Create DMG from the source folder"/>
        
        <sshexec host="${makedmg.remote.host}"
                 username="${makedmg.remote.user}"
		 port="${makedmg.remote.port}"
                 command="hdiutil create -fs HFS+ -srcfolder ~/.nbi-build/tmp -volname &quot;${dmg.name}&quot; ~/.nbi-build/dmg/image.dmg"
                 verbose="true"
                 trust="true"
                 keyfile="${makedmg.ssh.keyfile}"
                 passphrase="${makedmg.ssh.keypass}"/>

        <echo message=""/>
	<echo message="Copying file image.dmg back to the build system"/>
        
	<scp keyfile="${makedmg.ssh.keyfile}"
             passphrase="${makedmg.ssh.keypass}"
             verbose="true"
             trust="true"
             localTofile="${dmg.file}"
	     file="${makedmg.remote.user}@${makedmg.remote.host}:~/.nbi-build/dmg/image.dmg"/>

	<echo message=""/>
	<echo message="Clear temporary build directory on MacOS system"/>

	<sshexec host="${makedmg.remote.host}"
                 username="${makedmg.remote.user}"
		 port="${makedmg.remote.port}"
                 command="rm -rf ~/.nbi-build"
                 verbose="true"
                 trust="true"
                 keyfile="${makedmg.ssh.keyfile}"
                 passphrase="${makedmg.ssh.keypass}"/>

    </target>

    <target name="replace">
        <property file="${token.file}"/>
        <replaceregexp file="${file.to.replace}" flags="mg">
            <regexp pattern="${regexp.token}"/>
            <substitution expression="${regexp.replacement}"/>
        </replaceregexp>
    </target>
</project>
