#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

export SHELL = /bin/bash

#SOURCE_TARBALL = $(CURDIR)/upstream/netbeans-5_5-ide_sources.tar.gz
#SOURCE_TARBALL_URL = http://us2.mirror.netbeans.org/download/5_5/fcs/200610171010/netbeans-5_5-ide_sources.tar.gz
BUILD_TARBALL = $(CURDIR)/netbeans-5.5.tar.gz
#BUILD_TARBALL_URL = http://us2.mirror.netbeans.org/download/5_5/fcs/200610171010/netbeans-5_5.tar.gz

SOURCE_ROOT = $(DEBIAN_TMP)/netbeans-src
BUILD = $(SOURCE_ROOT)/nbbuild/netbeans

NBROOT = /usr/share/netbeans/5.5
DEBIAN_TMP = $(CURDIR)/debian/tmp

configure: configure-stamp
configure-stamp:
	dh_testdir
	touch configure-stamp

#$(BUILD_TARBALL):
#	wget -O $(BUILD_TARBALL) $(BUILD_TARBALL_URL)

unpack-build-tarball: $(BUILD_TARBALL)
	dh_testdir
	mkdir -p $(BUILD)
	tar xzf $(BUILD_TARBALL) -C $(BUILD)/..

#$(SOURCE_TARBALL):
#	wget -O $(SOURCE_TARBALL) $(SOURCE_TARBALL_URL)

#compile: $(SOURCE_TARBALL)
#	dh_testdir
#	mkdir -p $(DEBIAN_TMP)
#	tar xvzf $(SOURCE_TARBALL) -C $(DEBIAN_TMP)
#	(unset JAVA_HOME ; ANT_OPTS="-Xmx196m" /usr/bin/ant -f $(SOURCE_ROOT)/nbbuild/build.xml build-nozip)
	# delete junk
#	rm -f $(BUILD)/*.built $(BUILD)/build_info $(BUILD)/bin/*.exe $(BUILD)/bin/*.cmd

build: build-stamp
build-stamp: configure-stamp unpack-build-tarball
	touch $@

update-copyright: build-stamp
	sh debian/mkcopy.sh debian/copyright debian/extra/PKG_PREAMBLE debian/extra/PKG_NOTICE debian/extra/MIT_LICENSE debian/extra/NETBEANS_NOTICE $(BUILD)/LICENSE.txt $(BUILD)/THIRDPARTYLICENSE.txt $(BUILD)/platform6/THIRDPARTYLICENSEREADME.txt $(BUILD)/enterprise3/apache-tomcat-5.5.17/LICENSE $(BUILD)/enterprise3/modules/ext/toplink/3RD-PARTY-LICENSE.txt

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp

	# Add here commands to clean up after the build process.
	rm -rf $(DEBIAN_TMP)
	rm -f debian/copyright.1*

	dh_clean 

install: build update-copyright
	dh_testdir
	dh_testroot

	# platform
	mkdir -p $(CURDIR)/debian/netbeans5.5-platform$(NBROOT)
	#Remove Windows/OS2 specific files
	rm $(BUILD)/platform6/lib/nbexec.cmd
	# remove license files now in debian/copyright
	rm $(BUILD)/LICENSE.txt
	rm $(BUILD)/THIRDPARTYLICENSE.txt
	rm $(BUILD)/platform6/LICENSE.txt # redundant with ../LICENSE.txt
	rm $(BUILD)/platform6/THIRDPARTYLICENSEREADME.txt
	rm $(BUILD)/enterprise3/apache-tomcat-5.5.17/LICENSE
	rm $(BUILD)/enterprise3/modules/ext/toplink/3RD-PARTY-LICENSE.txt
	# remove Python script from embedded ant
	rm $(BUILD)/ide7/ant/bin/runant.py

	cp -r $(BUILD)/platform6 $(CURDIR)/debian/netbeans5.5-platform$(NBROOT)/
	mkdir -p $(CURDIR)/debian/netbeans5.5-platform/usr/share/doc/netbeans5.5-platform/
	mv $(CURDIR)/debian/netbeans5.5-platform$(NBROOT)/platform6/*.txt $(CURDIR)/debian/netbeans5.5-platform/usr/share/doc/netbeans5.5-platform/
	#for x in `find $(CURDIR)/debian/netbeans5.5-platform/$(NBROOT) -name \*.jar` ; do \
	#	echo "Packing $$x" ; \
	#	pack200 --no-gzip $$x.pack $$x ; \
	#	rm $$x ; \
	#done

	# IDE
	mkdir -p $(CURDIR)/debian/netbeans5.5$(NBROOT)
	#Remove Windows/OS2 specific files
	rm $(BUILD)/enterprise3/apache-tomcat-5.5.17/bin/*.bat
	rm $(BUILD)/enterprise3/apache-tomcat-5.5.17/bin/*.exe
	rm $(BUILD)/ide7/ant/bin/*.bat
	rm $(BUILD)/ide7/ant/bin/*.cmd
	rm $(BUILD)/bin/netbeans.cmd
	rm $(BUILD)/bin/nb.exe
	rm $(BUILD)/bin/netbeans.exe
	cp -r $(BUILD)/* $(CURDIR)/debian/netbeans5.5$(NBROOT)/
	rm -r $(CURDIR)/debian/netbeans5.5$(NBROOT)/platform6
	#Version specific manpage
	mkdir -p $(CURDIR)/debian/netbeans5.5$(NBROOT)/man
	cp $(CURDIR)/debian/netbeans.1 $(CURDIR)/debian/netbeans5.5$(NBROOT)/man
	gzip $(CURDIR)/debian/netbeans5.5$(NBROOT)/man/netbeans.1
	mkdir -p $(CURDIR)/debian/netbeans5.5/usr/share/doc/netbeans5.5/
	mv $(CURDIR)/debian/netbeans5.5$(NBROOT)/*.txt $(CURDIR)/debian/netbeans5.5/usr/share/doc/netbeans5.5/
	mv $(CURDIR)/debian/netbeans5.5$(NBROOT)/*.html $(CURDIR)/debian/netbeans5.5/usr/share/doc/netbeans5.5/
	mv $(CURDIR)/debian/netbeans5.5$(NBROOT)/*.css $(CURDIR)/debian/netbeans5.5/usr/share/doc/netbeans5.5/

	mkdir -p $(CURDIR)/debian/netbeans5.5/usr/share/applications
	cp $(CURDIR)/debian/extra/netbeans.desktop $(CURDIR)/debian/netbeans5.5/usr/share/applications/netbeans.desktop

	mkdir -p $(CURDIR)/debian/netbeans5.5/usr/bin
        #Created using alternatives
	#now done in netbeans5.5-postinst
	#ln -sf $(NBROOT)/bin/netbeans $(CURDIR)/debian/netbeans5.5/usr/bin/netbeans

	# replace bundled jars with links to jars from packages
	#cat $(CURDIR)/debian/extra/links.txt | while read FROM TO; do \
	#    if [ -a $(CURDIR)/debian/netbeans5.5$(NBROOT)/$$TO ] ; then  \
	#	rm -r $(CURDIR)/debian/netbeans5.5$(NBROOT)/$$TO; \
	#        ln -sf $$FROM $(CURDIR)/debian/netbeans5.5$(NBROOT)/$$TO; \
	#    fi \
	#done

	#for x in `find $(CURDIR)/debian/netbeans5.5$(NBROOT) -name \*.jar` ; do \
	#	echo "Packing $$x" ; \
	#	pack200 --no-gzip $$x.pack $$x ; \
	#	rm $$x ; \
	#done

	# Installing lintian overrides
	for LINTIAN in debian/lintian/netbeans*; \
	do \
		install -D -m 0644 $$LINTIAN debian/`basename $$LINTIAN`/usr/share/lintian/overrides/`basename $$LINTIAN` || exit 1; \
	done

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installdocs
	dh_installmenu
	dh_installman
	dh_installchangelogs
	dh_compress
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture-dependent files here.
binary-arch: build install
# nothing to do here

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
