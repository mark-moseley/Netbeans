/*
 *                 Sun Public License Notice
 * 
 * The contents of this file are subject to the Sun Public License
 * Version 1.0 (the "License"). You may not use this file except in
 * compliance with the License. A copy of the License is available at
 * http://www.sun.com/
 * 
 * The Original Code is NetBeans. The Initial Developer of the Original
 * Code is Sun Microsystems, Inc. Portions Copyright 1997-2000 Sun
 * Microsystems, Inc. All Rights Reserved.
 */
/*
 * OpenTestAction.java
 *
 * Created on February 28, 2001, 7:08 PM
 */

package org.netbeans.modules.junit;

import org.openide.*;
import org.openide.nodes.*;
import org.openide.util.HelpCtx;
import org.openide.util.NbBundle;
import org.openide.util.actions.CookieAction;
import org.openide.loaders.*;
import org.openide.src.*;
import org.openide.filesystems.*;
import org.openide.filesystems.FileSystem; // override java.io.FileSystem
import org.openide.cookies.*;

import java.lang.reflect.*;
import java.util.*;
import java.io.*;

/** Action sensitive to some cookie that does something useful.
 *
 * @author  Nathan W. Phelps
 * @ version 1.0
 */
public class OpenTestAction extends CookieAction {

    protected Class[] cookieClasses () {
        //return new Class[] { DataFolder.class, ClassElement.class };
        return new Class[] { DataFolder.class, SourceCookie.class, ClassElement.class };
    }

    protected int mode () {
        // return MODE_EXACTLY_ONE;
        return MODE_ALL;
    }

    protected void performAction (Node[] nodes) {
        FileSystem      fsTest = null;
        DataObject      doTestClass = null;
        String          temp;
        
        // get the target file system
        temp = JUnitSettings.getDefault().getFileSystem();
        
        if (null == (fsTest = Repository.getDefault().findFileSystem(temp))) {
            String msg = NbBundle.getMessage(OpenTestAction.class, "MSG_file_system_not_found");
            NotifyDescriptor descr = new NotifyDescriptor.Message(msg, NotifyDescriptor.ERROR_MESSAGE);
            org.openide.DialogDisplayer.getDefault().notify(descr);
            return;
        }
        
        for (int i = 0; i < nodes.length; i++) {
            try {
                // get test class or suite class file, if it was not such one pointed by the node
                
                FileObject foTestedClass = TestUtil.getFileObjectFromNode(nodes[i]);
                
                if (!TestUtil.isTestClassFile(foTestedClass.getPackageName('.')) &&
                !TestUtil.isTestSuiteFile(foTestedClass.getPackageName('.'))) {
                    // find the test class
                    if (foTestedClass.isFolder())
                        foTestedClass = fsTest.findResource(TestUtil.getTestSuiteFullName(foTestedClass));
                    else
                        foTestedClass = fsTest.findResource(TestUtil.getTestClassFullName(foTestedClass));
                }
                
                doTestClass = DataObject.find(foTestedClass);
                
                EditorCookie task = (EditorCookie)doTestClass.getCookie(EditorCookie.class);
                task.open();
            }
            catch (Exception e) {
                String msg = NbBundle.getMessage(OpenTestAction.class, "MSG_test_file_not_found");
                msg += " (" + temp + ")";
                NotifyDescriptor descr = new NotifyDescriptor.Message(msg, NotifyDescriptor.ERROR_MESSAGE);
                org.openide.DialogDisplayer.getDefault().notify(descr);
                return;
            }
        }
    }

    public String getName () {
        return NbBundle.getMessage (OpenTestAction.class, "LBL_Action_OpenTest");
    }

    protected String iconResource () {
        return "org/netbeans/modules/junit/resources/OpenTestActionIcon.gif";
    }

    public HelpCtx getHelpCtx () {
        return new HelpCtx(OpenTestAction.class);
    }

    /** Perform special enablement check in addition to the normal one.
    protected boolean enable (Node[] nodes) {
	if (! super.enable (nodes)) return false;
	if (...) ...;
    }
    */

    protected void initialize () {
	super.initialize ();
        putProperty(javax.swing.Action.SHORT_DESCRIPTION, NbBundle.getMessage(OpenTestAction.class, "HINT_Action_OpenTest"));
    }
}
