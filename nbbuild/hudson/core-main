#!/bin/sh

[ "$action" = "build" ] || [ "$action" = "sync" ] || exit 101

[ -n "$push_username" ] || exit 102
[ -n "$push_password" ] || exit 103


ANT_OPTS="-Xmx512m"
export ANT_OPTS
HGMERGE=merge
export HGMERGE

rm -rf real.workspace
hg clone . real.workspace || exit 1
cd real.workspace

if [ "$action" = "build" ]; then
#    hg fetch http://hg.netbeans.org/main || exit 1
    hg pull http://hg.netbeans.org/main || exit 1
    if [ `hg heads --template '{node|short}\n' | wc -l` = 1 ]
    then
       hg up || exit 6
    else
       hg merge || exit 7
       hg ci -m 'Automated merge' || exit 8
    fi

    ant -f nbbuild/build.xml build || exit 2
    ant -f nbbuild/build.xml commit-validation commit-validation-junit-format # || exit 3
    ant -f openide.util/build.xml test  || exit 4
    ant -f openide.modules/build.xml test || exit 4
    ant -f openide.filesystems/build.xml test # || exit 4
# masterfs is currently broken, Radek wants me to disable it until 6.1M2:
#    ant -f masterfs/build.xml test # || exit 4
    ant -f openide.nodes/build.xml test # || exit 4
    ant -f openide.options/build.xml test # || exit 4
    ant -f openide.dialogs/build.xml test # || exit 4
    ant -f openide.awt/build.xml test # || exit 4
    ant -f openide.windows/build.xml test # || exit 4
    ant -f openide.io/build.xml test # || exit 4
    if [ `hg out --template '{node|short}\n' http://hg.netbeans.org/main | wc -l` > 0 ]; then
        echo No outgoing changes
#        exit 0
    fi

    for i in 1 2 3; do
       hg pull http://hg.netbeans.org/main || exit 5
       if [ `hg heads --template '{node|short}\n' | wc -l` = 1 ]
       then
           hg up || exit 6
       else
           hg merge || exit 7
           hg ci -m 'Automated merge' || exit 8
       fi
       hg out http://hg.netbeans.org/main
       hg in http://hg.netbeans.org/main
       hg push https://"$push_username":"$push_password"@hg.netbeans.org/main && exit 0
    done
    exit 5
fi

if [ "$action" = "sync" ]; then
    HEADS=`hg heads --template "{node}\n" | wc -l`
    if [ $HEADS = 2 ]; then
      hg merge
      hg ci -m "Automated merge"
      hg up -C
    fi
    hg fetch http://hg.netbeans.org/core-main
    hg push https://"$push_username":"$push_password"@hg.netbeans.org/core-main
    exit 0
fi




