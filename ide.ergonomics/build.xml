<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="netbeans" name="ide.ergonomics">
    <description>Builds, tests, and runs the project org.netbeans.modules.ide.ergonomics</description>
    <import file="../nbbuild/templates/projectized.xml"/>

    <target name="-release.dir" depends="-disable-kits,projectized-common.-release.dir"/>

    <!--
    -
    - Internal implementation
    -
    -->

    <target name="-disable-kits" depends="init-tasks">
        <mkdir dir="${release.dir}/config/Modules"/>
        <subant genericantfile="build.xml" target="-process-one-cluster">
            <property name="xmldir" value="${release.dir}/config/Modules"/>
            <property name="proxytmp" location="build/proxies"/>
            <property name="proxyxslt" location="project-wizard.xsl"/>
            <property name="proxydir" location="build/classes/org/netbeans/modules/ide/ergonomics"/>
            <dirset dir="${netbeans.dest.dir}">
                <include name="*"/>
                <exclude name="ide1*"/>
                <exclude name="platform*"/>
                <exclude name="nb*.*"/>
                <exclude name="bin"/>
                <exclude name="etc"/>
            </dirset>
        </subant>
    </target>


    <target name="-process-one-cluster" depends="-proxy-one-cluster,-disable-one-cluster"/>

    <target name="-proxy-one-cluster" depends="init-tasks">
        <taskdef name="layerindex"
             classname="org.netbeans.nbbuild.LayerIndex"
             classpath="${nb_all}/nbbuild/nbantext.jar"/>
        <layerindex resourceid="layers">
            <modules dir=".">
                <include name="modules/*.jar"/>
            </modules>
        </layerindex>

        <pathconvert property="cluster.name">
            <path location="."/>
            <mapper type="flatten"/>
        </pathconvert>

        <mkdir dir="${proxytmp}"/>
        <copy todir="${proxytmp}">
            <resources refid="layers"/>
        </copy>

        <xslt destdir="${proxytmp}/out" style="${proxyxslt}" useimplicitfileset="false" extension="fragment">
            <fileset dir="${proxytmp}">
                <include name="*.xml"/>
            </fileset>
        </xslt>

        <concat destfile="${proxydir}/${cluster.name}.xml">
            <filterchain>
                <ignoreblank byline="true"/>
            </filterchain>
            <fileset dir="${proxytmp}/out">
            </fileset>
        </concat>
    </target>
    <target name="-disable-one-cluster" depends="init-tasks">
        <createmodulexml xmldir="${xmldir}">
            <disabled dir=".">
                <and>
                    <filename name="modules/*.jar"/>
                    <custom 
                        classname="org.netbeans.nbbuild.ModuleStateSelector"
                        classpath="${nb_all}/nbbuild/nbantext.jar"
                    >
                        <param name="acceptEnabled" value="true"/>
                    </custom>
                </and>
            </disabled>
        </createmodulexml>
    </target>
</project>
