<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="netbeans" name="ide.ergonomics">
    <description>Builds, tests, and runs the project org.netbeans.modules.ide.ergonomics</description>
    <import file="../nbbuild/templates/projectized.xml"/>

    <target name="-release.dir" depends="-disable-kits,projectized-common.-release.dir"/>

    <!--
    -
    - Internal implementation
    -
    -->

    <target name="-disable-kits" depends="init-tasks">
        <mkdir dir="${release.dir}/config/Modules"/>
        <subant genericantfile="build.xml" target="-process-one-cluster">
            <property name="xmldir" value="${release.dir}/config/Modules"/>
            <property name="ergonomicsdir" location="${basedir}"/>
            <dirset dir="${netbeans.dest.dir}">
                <include name="*"/>
                <exclude name="harness*"/>
                <exclude name="ide1*"/>
                <exclude name="platform*"/>
                <exclude name="nb*.*"/>
                <exclude name="bin"/>
                <exclude name="etc"/>
            </dirset>
        </subant>
    </target>


    <target name="-process-one-cluster" depends="-proxy-one-cluster,-disable-one-cluster"/>

    <target name="-proxy-one-cluster" depends="init-tasks">
        <taskdef name="layerindex"
             classname="org.netbeans.nbbuild.LayerIndex"
             classpath="${nb_all}/nbbuild/nbantext.jar"/>
        <layerindex resourceid="layers">
            <modules dir=".">
                <include name="modules/*.jar"/>
            </modules>
        </layerindex>

        <pathconvert property="cluster.name">
            <path location="."/>
            <mapper type="flatten"/>
        </pathconvert>

        <property name="proxytmp" value="${ergonomicsdir}/build/proxies/${cluster.name}"/>
        <property name="proxydir" value="${ergonomicsdir}/build/classes/org/netbeans/modules/ide/ergonomics/"/>
        <mkdir dir="${proxytmp}"/>
        <copy todir="${proxytmp}">
            <resources refid="layers"/>
        </copy>


        <xslt
            basedir="${proxytmp}"
            destdir="${proxytmp}/out" style="${ergonomicsdir}/project-wizard.xsl"
            useimplicitfileset="true" extension=".fragment"
        />

        <mkdir dir="${proxydir}"/>
        <concat destfile="${proxydir}/${cluster.name}.xml">
            <header>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE filesystem PUBLIC "-//NetBeans//DTD Filesystem 1.1//EN" "http://www.netbeans.org/dtds/filesystem-1_1.dtd"&gt;
&lt;filesystem&gt;
    &lt;folder name="Templates"&gt;
        &lt;folder name="Project"&gt;
            </header>
            <filterchain>
                <ignoreblank byline="true"/>
            </filterchain>
            <fileset dir="${proxytmp}/out">
            </fileset>
            <footer>
        &lt;/folder&gt;
    &lt;/folder&gt;
&lt;/filesystem&gt;
            </footer>
        </concat>
    </target>
    <target name="-disable-one-cluster" depends="init-tasks">
        <createmodulexml xmldir="${xmldir}">
            <disabled dir=".">
                <and>
                    <filename name="modules/*.jar"/>
                    <custom 
                        classname="org.netbeans.nbbuild.ModuleStateSelector"
                        classpath="${nb_all}/nbbuild/nbantext.jar"
                    >
                        <param name="acceptEnabled" value="true"/>
                    </custom>
                </and>
            </disabled>
        </createmodulexml>
    </target>
</project>
