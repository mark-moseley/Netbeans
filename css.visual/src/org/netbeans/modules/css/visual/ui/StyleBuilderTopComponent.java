/*
 * The contents of this file are subject to the terms of the Common Development
 * and Distribution License (the License). You may not use this file except in
 * compliance with the License.
 *
 * You can obtain a copy of the License at http://www.netbeans.org/cddl.html
 * or http://www.netbeans.org/cddl.txt.
 *
 * When distributing Covered Code, include this CDDL Header Notice in each file
 * and include the License file at http://www.netbeans.org/cddl.txt.
 * If applicable, add the following below the CDDL Header, with the fields
 * enclosed by brackets [] replaced by your own identifying information:
 * "Portions Copyrighted [year] [name of copyright owner]"
 *
 * The Original Software is NetBeans. The Initial Developer of the Original
 * Software is Sun Microsystems, Inc. Portions Copyright 1997-2007 Sun
 * Microsystems, Inc. All Rights Reserved.
 */
package org.netbeans.modules.css.visual.ui;

import org.netbeans.modules.css.visual.api.StyleBuilderPanel;
import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Cursor;
import java.io.Serializable;
import java.util.logging.Logger;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.SwingConstants;
import org.netbeans.modules.css.model.CssRule;
import org.openide.util.NbBundle;
import org.openide.windows.TopComponent;
import org.openide.windows.WindowManager;
import org.openide.util.Utilities;

/**
 * CssStyleBuilder TopComponent
 *
 * @author Marek Fukala
 */
public final class StyleBuilderTopComponent extends TopComponent {
    
    //StyleBuilder UI states
    /** Model is updating, show wait clocks.*/
    public static final int MODEL_UPDATING = 1;
    /** Model OK, UI works.*/
    public static final int MODEL_OK = 2;
    /** Model broken, error panel shown. */
    public static final int MODEL_ERROR = 3;
    /** Model OK, but no rule selected, show warning panel */
    public static final int OUT_OF_RULE = 4;
    
    
    private static final String DEFAULT_TC_NAME = NbBundle.getMessage(StyleBuilderTopComponent.class, "CTL_CSSStyleBuilderTopComponent");
    
    private static StyleBuilderTopComponent instance;
    /** path to the icon used by the component and its open action */
    static final String ICON_PATH = "org/netbeans/modules/css/resources/style_builder_view_toolbar.png";
    
    private static final String PREFERRED_ID = "StyleBuilderTC";
    
    private StyleBuilderPanel styleBuilderPanel = StyleBuilderPanel.createInstance();
    
    private JPanel BROKEN_MODEL_PANEL, NO_RULE_SELECTED_PANEL;
    
    private StyleBuilderTopComponent() {
        initComponents();
        
        setToolTipText(NbBundle.getMessage(StyleBuilderTopComponent.class, "HINT_CSSStyleBuilderTopComponent"));
        setIcon(Utilities.loadImage(ICON_PATH, true));
        
        NO_RULE_SELECTED_PANEL = makeMsgPanel(NbBundle.getMessage(StyleBuilderTopComponent.class, "Out_Of_Rule"));
        BROKEN_MODEL_PANEL = makeMsgPanel(NbBundle.getMessage(StyleBuilderTopComponent.class, "Broken_Model"));
        
    }
    
    private JPanel makeMsgPanel(String message) {
        JPanel p = new JPanel();
        p.setBackground(Color.WHITE);
        p.setLayout(new BorderLayout());
        JLabel msgLabel = new JLabel(message);
        p.add(msgLabel, BorderLayout.CENTER);
        msgLabel.setHorizontalAlignment(SwingConstants.CENTER);
        return p;
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc=" Generated Code ">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane1 = new javax.swing.JScrollPane();

        setLayout(new java.awt.BorderLayout());
        add(jScrollPane1, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JScrollPane jScrollPane1;
    // End of variables declaration//GEN-END:variables
    
    
    /**
     * Gets default instance. Do not use directly: reserved for *.settings files only,
     * i.e. deserialization routines; otherwise you could get a non-deserialized instance.
     * To obtain the singleton instance, use {@link findInstance}.
     */
    public static synchronized StyleBuilderTopComponent getDefault() {
        if (instance == null) {
            instance = new StyleBuilderTopComponent();
        }
        return instance;
    }
    
    /**
     * Obtain the CSSStyleBuilderTopComponent instance. Never call {@link #getDefault} directly!
     */
    public static synchronized StyleBuilderTopComponent findInstance() {
        TopComponent win = WindowManager.getDefault().findTopComponent(PREFERRED_ID);
        if (win == null) {
            Logger.getLogger(StyleBuilderTopComponent.class.getName()).warning(
                    "Cannot find " + PREFERRED_ID + " component. It will not be located properly in the window system.");
            return getDefault();
        }
        if (win instanceof StyleBuilderTopComponent) {
            return (StyleBuilderTopComponent)win;
        }
        Logger.getLogger(StyleBuilderTopComponent.class.getName()).warning(
                "There seem to be multiple components with the '" + PREFERRED_ID +
                "' ID. That is a potential source of errors and unexpected behavior.");
        return getDefault();
    }
    
    public int getPersistenceType() {
        return TopComponent.PERSISTENCE_ALWAYS;
    }
    
    public void componentActivated() {
        super.componentActivated();
    }
    
    /** replaces this in object stream */
    public Object writeReplace() {
        return new ResolvableHelper();
    }
    
    protected String preferredID() {
        return PREFERRED_ID;
    }
    
    final static class ResolvableHelper implements Serializable {
        private static final long serialVersionUID = 1L;
        public Object readResolve() {
            return StyleBuilderTopComponent.getDefault();
        }
    }
    
    public void setActiveRule(final CssRule rule){
        setName((rule != null ? rule.name() + " - " : "") + DEFAULT_TC_NAME);
        styleBuilderPanel.setContent(rule.ruleContent());
    }
    
    public void setPanelMode(int mode) {
        JPanel shownPanel = null;
        switch(mode) {
        case MODEL_OK:
            styleBuilderPanel.setCursor(null);
            jScrollPane1.setViewportView(styleBuilderPanel);
            break;
        case MODEL_ERROR:
            setName(DEFAULT_TC_NAME);//set default TC name
            jScrollPane1.setViewportView(BROKEN_MODEL_PANEL);
            break;
        case MODEL_UPDATING:
            styleBuilderPanel.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));
            break;
        case OUT_OF_RULE:
            setName(DEFAULT_TC_NAME);//set default TC name
            jScrollPane1.setViewportView(NO_RULE_SELECTED_PANEL);
            break;
        default:
            throw new IllegalArgumentException("Invalid StyleBuilder mode = " + mode);
        }
        
        
    }
}