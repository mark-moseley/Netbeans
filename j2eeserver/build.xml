<?xml version="1.0" encoding="UTF-8"?>
<!--
                Sun Public License Notice

The contents of this file are subject to the Sun Public License
Version 1.0 (the "License"). You may not use this file except in
compliance with the License. A copy of the License is available at
http://www.sun.com/

The Original Code is NetBeans. The Initial Developer of the Original
Code is Sun Microsystems, Inc. Portions Copyright 1997-2002 Sun
Microsystems, Inc. All Rights Reserved.
-->

<project basedir="." default="netbeans" name="j2eeserver">

  <property name="nbroot" location=".."/>
  <property name="nbext" location="${nbroot}/nbbuild"/>
  <property name="nbm_alias" value="nb_ide"/>
  <property name="homepage.base" value="netbeans.org"/>
  <property name="dist.base" value="www.netbeans.org/download/nbms/40"/>
  <property name="license.file" value="../nbbuild/standard-nbm-license.txt"/>
  <property name="build" location="../nbbuild/netbeans"/>

  <property name="stubtarget" value="testbase/src"/>
  
  <taskdef classname="org.netbeans.nbbuild.LocalizedJar" classpath="${nbext}/nbantext.jar" name="locjar"/>
  <taskdef name="genlist" classname="org.netbeans.nbbuild.MakeListOfNBM" classpath="../nbbuild/nbantext.jar"/>
  <taskdef name="makenbm" classname="org.netbeans.nbbuild.MakeNBM" classpath="${nbext}/nbantext.jar"/>

  <patternset id="j2eeserver.files">
    <include name="modules/autoload/j2eeserver.jar"/>
  </patternset>

  <!-- These are the primary targets. -->

  <target name="netbeans" depends="jars">
      <genlist outputfiledir="${build}" module="modules/autoload/j2eeserver.jar">
          <fileset dir="${build}">
	      <patternset refID="j2eeserver.files"/>
          </fileset>
      </genlist>
  </target>

  <target name="nbm" depends="netbeans">
    <makenbm file="j2eeserver.nbm"
             productDir="${build}"
             module="modules/autoload/j2eeserver.jar"
             homepage="http://${homepage.base}/j2eeserver.html"
             distribution="http://${dist.base}/j2eeserver.nbm">
      <license file="${license.file}" />
      <signature keystore="${keystore}" storepass="${storepass}" alias="${nbm_alias}"/>
    </makenbm>
  </target>

  <target name="clean">
    <delete>
      <fileset dir="src">
        <include name="**/*.class"/>
        <include name="**/*.jar"/>
      </fileset>
      <fileset dir="${build}">
        <patternset refID="j2eeserver.files"/>
     </fileset>
    </delete>
    <delete file="j2eeserver.nbm"/>
    <delete file="manifest-subst.mf"/>
  </target>

  <target name="javadoc">
    <mkdir dir="doc/"/>
    <taskdef classname="org.netbeans.nbbuild.GenerateJavadoc" classpath="${nbroot}/nbbuild/nbantext.jar" name="genjavadoc"/>
    <genjavadoc destdir="doc/" modules="j2eeserver">
       <topdir path="${nbroot}"/>
     </genjavadoc>
  </target>

  <target name="apidoc">
    <property name="jdk-docs-location" value="http://java.sun.com/j2se/1.3/docs/api"/>
    <tstamp/>
    <property name="open-apis-footer" value="&lt;font size=-2
    color=gray&gt;Built on ${TODAY}.&amp;nbsp;&amp;nbsp;|&amp;nbsp;&amp;nbsp;Portions Copyright 2000-2001 Sun Microsystems, Inc. All rights reserved.&lt;/font&gt;"/>
    <echo message="Build Server Integration API documentation..."/>
    <mkdir dir="serverdoc"/>
    <javadoc destdir="serverdoc"
             packagenames="org.netbeans.modules.j2ee.server,org.netbeans.modules.j2ee.server.web,org.netbeans.modules.j2ee.server.ejb,org.netbeans.modules.j2ee.server.datamodel,org.netbeans.modules.j2ee.server.ejbmodule,org.netbeans.modules.j2ee.server.app,org.netbeans.modules.j2ee.server.appasm,org.netbeans.modules.j2ee.server.appclient,org.netbeans.modules.j2ee.server.importear,org.netbeans.modules.j2ee.deployment.api"
             doctitle="Forte4j Server Integration APIs"
             windowtitle="Forte4j Server Integration APIs"
             overview="api/doc/overview.html"
             bottom="${open-apis-footer}"
             use="true"
             splitindex="true"
             author="false"
             version="false"
             maxmemory="64m"
    >
      <sourcepath>
        <pathelement location="api/doc"/>
        <pathelement location="src"/>
      </sourcepath>
      <classpath>
        <pathelement location="${nbroot}/openide/openide-13javac-workaround.jar"/>
        <fileset dir="${nbroot}/openide/netbeans/lib">
                <include name="openide*.jar"/>
        </fileset>
        <pathelement location="${nbroot}/jarpackager/netbeans/modules/jarpackager.jar"/>
        <pathelement location="${nbroot}/debuggerjpda/netbeans/modules/jpdaDebugger.jar"/>
      </classpath>
      <link href="${jdk-docs-location}"
            offline="true"
            packagelistLoc="api/doc"
      />
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/doc-files/api.html&quot;&gt;Generic server integration api&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server"/>
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/datamodel/doc-files/api.html&quot;&gt;Server integration data model&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server/datamodel"/>
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/web/doc-files/api.html&quot;&gt;Web server integration api&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server/web"/>
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/ejb/doc-files/api.html&quot;&gt;Ejb server integration api&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server/ejb"/>
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/ejbmodule/doc-files/api.html&quot;&gt;Ejbmodule server integration api&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server/ejbmodule"/>
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/appasm/doc-files/api.html&quot;&gt;Application Assembly server integration api&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server/appasm"/>
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/app/doc-files/api.html&quot;&gt;Application server integration api&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server/app"/>
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/appclient/doc-files/api.html&quot;&gt;Application Client server integration api&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server/appclient"/>
      <group title="&lt;a href=&quot;@TOP@org/netbeans/modules/j2ee/server/importear/doc-files/api.html&quot;&gt;Application import server integration api&lt;/a&gt;"
             packages="org/netbeans/modules/j2ee/server/importear"/>
    </javadoc>
    <copy file="src/org/netbeans/modules/j2ee/deployment/api/netbeans-deployment.dtd"
  tofile="serverdoc/org/netbeans/modules/j2ee/deployment/api/netbeans-deployment.dtd"/>
    <zip zipfile="serverintegration.zip" basedir="serverdoc"/>
  </target>

  <!-- These are the secondary targets. -->

  <target name="jars" depends="compile" >
    <mkdir dir="${build}/modules/autoload"/>
    <filter token="BUILD_NUMBER_SUBST" value="${buildnumber}"/>
    <copy file="manifest.mf" 
          tofile="manifest-subst.mf"
          filtering="on"/>
    <locjar compress="false" 
            jarfile="${build}/modules/autoload/j2eeserver.jar"
	    manifest="manifest-subst.mf">
      <locale name="ja"/>
      <fileset dir="src" excludesfile="${nbroot}/nbbuild/standard-jar-excludes.txt"/>
    </locjar>
  </target>

  <target name="compilestub" depends="jars">
    <javac srcdir="testbase/src" destdir="${stubtarget}">
      <classpath>
        <pathelement location="${nbroot}/openide/openide-13javac-workaround.jar"/>
        <fileset dir="${nbroot}/openide/netbeans/lib">
                <include name="openide*.jar"/>
        </fileset>
        <pathelement location="${build}/lib/ext/logger.jar"/>
        <pathelement location="${build}/modules/jarpackager.jar"/>
        <pathelement location="${build}/modules/jpdaDebugger.jar"/>
        <pathelement location="${build}/modules/autoload/debuggerCore.jar"/>
        <pathelement location="${jdkhome}/lib/tools.jar"/>
        <pathelement location="${build}/modules/autoload/j2eeserver.jar"/>
      </classpath>
    </javac>
  </target>
  
  <target name="compile" depends="setup-jdkhome">
    <javac srcdir="src" destdir="src" deprecation="${build.compiler.deprecation}" debug="${build.compiler.debug}" excludes="org/netbeans/modules/j2ee/deployment/model/**,org/netbeans/modules/j2ee/deployment/support/**">
      <classpath>
        <pathelement location="${nbroot}/openide/openide-13javac-workaround.jar"/>
        <pathelement location="${build}/lib/openide.jar"/>
        <pathelement location="${build}/modules/autoload/openide-deprecated.jar"/> <!-- XXX -->
        <pathelement location="${build}/modules/autoload/java-src-model.jar"/>
        <pathelement location="${build}/modules/autoload/openide-compiler.jar"/>
        <pathelement location="${build}/modules/autoload/openide-execution.jar"/>
        <pathelement location="${build}/modules/autoload/openide-io.jar"/> <!-- used indirectly, not imported -->
        <pathelement location="${jdkhome}/lib/tools.jar"/>
        <pathelement location="${build}/modules/jarpackager.jar"/>
        <pathelement location="${build}/modules/jpdaDebugger.jar"/>
        <pathelement location="${build}/modules/autoload/debuggerCore.jar"/>
      </classpath>
    </javac>
  </target>

  <target name="setup-jdkhome-1">
    <!-- Note: user-configured -Djavahome=... will always override this: -->
    <property name="javahome" location="${java.home}"/>
    <available property="javahome-valid" file="${javahome}/lib/tools.jar"/>
  </target>
  <target name="setup-jdkhome-2" depends="setup-jdkhome-1" if="javahome-valid">
    <property name="jdkhome" value="${javahome}"/>
    <property name="jdkhome-valid" value="true"/>
  </target>
  <target name="setup-jdkhome-3" depends="setup-jdkhome-1" unless="javahome-valid">
    <property name="jdkhome" location="${javahome}/.."/>
    <available property="jdkhome-valid" file="${jdkhome}/lib/tools.jar"/>
  </target>
  <target name="setup-jdkhome" depends="setup-jdkhome-2,setup-jdkhome-3" unless="jdkhome-valid">
    <fail message="No tools.jar found in ${javahome}! Set -Djavahome=... as needed."/>
  </target>

  <!-- This target will only work *inside* the IDE!
  <target depends="netbeans" description="Test the module inside the running IDE." name="test">
    <nbinstaller action="reinstall" module="${build}/modules/j2eeserver.jar"/>
  </target> -->


</project>
