<?xml version="1.0" encoding="UTF-8"?>
<!-- ===========================================================================
  The contents of this file are subject to the terms of the Common Development
  and Distribution License (the License). You may not use this file except in
  compliance with the License.
  
  You can obtain a copy of the License at http://www.netbeans.org/cddl.html
  or http://www.netbeans.org/cddl.txt.
  
  When distributing Covered Code, include this CDDL Header Notice in each file
  and include the License file at http://www.netbeans.org/cddl.txt.
  If applicable, add the following below the CDDL Header, with the fields
  enclosed by brackets [] replaced by your own identifying information:
  "Portions Copyrighted [year] [name of copyright owner]"
  
  The Original Software is NetBeans. The Initial Developer of the Original
  Software is Sun Microsystems, Inc. Portions Copyright 1997-2006 Sun
  Microsystems, Inc. All Rights Reserved.
  
  $Id$
============================================================================ -->

<!--
    This is a target library which is intended to be used by other build 
    scripts, currently - engine, product and group. It contains utility
    targets which perform the required initialization, clean-up and build 
    functionality.
-->
<project name="build-common" default="usage" basedir=".">
    <!-- load the properties common to all build scripts -->
    <property file="${.common.dir}/build.properties"/>
    
    <!-- =======================================================================
        Initialization
    ======================================================================== -->
    <!--
        This target performs the default initialization, all custom ant tasks 
        are defined here. It also sets some properties which control the flow
        of the build process.
    -->
    <target name="-init" depends=".build-custom-tasks">
        <!-- define custom ant tasks -->
        <taskdef 
            name="for-each" 
            classname="org.netbeans.installer.infra.build.ant.ForEach" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="set-property" 
            classname="org.netbeans.installer.infra.build.ant.SetProperty" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="package" 
            classname="org.netbeans.installer.infra.build.ant.Package" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="sizeof" 
            classname="org.netbeans.installer.infra.build.ant.SizeOf" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="sum" 
            classname="org.netbeans.installer.infra.build.ant.Sum" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="join" 
            classname="org.netbeans.installer.infra.build.ant.Join" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="md5" 
            classname="org.netbeans.installer.infra.build.ant.Md5" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="load-locales" 
            classname="org.netbeans.installer.infra.build.ant.LoadLocales" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="evaluate" 
            classname="org.netbeans.installer.infra.build.ant.Evaluate" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="product-descriptor" 
            classname="org.netbeans.installer.infra.build.ant.XmlProduct" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="group-descriptor" 
            classname="org.netbeans.installer.infra.build.ant.XmlGroup" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="update-group" 
            classname="org.netbeans.installer.infra.build.ant.PutGroup" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="update-product" 
            classname="org.netbeans.installer.infra.build.ant.PutProduct" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="update-engine" 
            classname="org.netbeans.installer.infra.build.ant.PutEngine" 
            classpath="${custom.tasks.cls}"/>
        <taskdef 
            name="if" 
            classname="org.netbeans.installer.infra.build.ant.If" 
            classpath="${custom.tasks.cls}"/>
        
        <!-- decide whether to checkout sources from trunk --> 
        <condition property="do.checkout.trunk">
            <and>
                <equals arg1="${cvs.branch}" arg2=""/>
                <equals arg1="${checkout.sources}" arg2="true"/>
            </and>
        </condition>
        
        <!-- decide whether to checkout sources from a branch --> 
        <condition property="do.checkout.branch">
            <and>
                <not>
                    <equals arg1="${cvs.branch}" arg2=""/>
                </not>
                <equals arg1="${checkout.sources}" arg2="true"/>
            </and>
        </condition>
        
        <!-- decide whether to copy sources from a location -->
        <condition property="do.copy.sources">
            <not>
                <equals arg1="${checkout.sources}" arg2="true"/>
            </not>
        </condition>
        
        <!-- decide whether to build native (jni) libraries or not -->
        <condition property="do.build.native">
            <equals arg1="${build.native}" arg2="true"/>
        </condition>
        
        <!-- initialize the local working directory -->
        <mkdir dir="${work.dir}"/>
        
        <!-- initialize the local distributive directory -->
        <mkdir dir="${dist.dir}"/>
    </target>
    
    <target name=".build-custom-tasks" unless="skip.build.custom.tasks">
        <!-- build custom ant tasks -->
        <delete dir="${custom.tasks.cls}"/>
        <mkdir dir="${custom.tasks.cls}"/>
        
        <javac 
            srcdir="${custom.tasks.src}" 
            destdir="${custom.tasks.cls}" 
            debug="true"/>
        
        <property name="skip.build.custom.tasks" value="true"/>
    </target>
    
    <!-- =======================================================================
        Clean-up
    ======================================================================== -->
    <!--
        This is the main clean-up target, it cleans the native libraries, tries
        to run cleanup on the java project and finally deletes the checked out 
        sources.
    -->
    <target name="-clean" depends="-init,-pre-clean,.clean-native,.clean-java">
        <!-- delete the local working directory -->
        <delete dir="${work.dir}" includeemptydirs="true"/>
    </target>
    
    <!--
        A hook that allows executing something custom prior to clean-up
    -->
    <target name="-pre-clean"/>
    
    <!--
      - Cleans up the native libraries. It iterates over the list of platforms 
      - supplied via ${platforms} and calls the utility target (which 
      - actually performs the clean-up procedure) for each.
      - 
      - Execution of the target is controlled by the ${do.build.native} 
      - property, whose existance in turn is controlled by the value of the 
      - ${build.native} property ("true"/"false").
      - 
      - It is important that <antcall> is used here - it allows to safely 
      - load platform-specific properties, without any risk that they will get 
      - propagated to the calling target.
    -->
    <target name=".clean-native" depends="init" if="do.build.native">
        <for-each list="${platforms}" property="platform">
            <antcall target="..clean-native"/>
        </for-each>
    </target>
    
    <!--
        This target removes the locally cached native library for a given 
        platform.
    -->
    <target name="..clean-native">
        <!-- load properties pertaining to the given platform -->
        <property file="${native.properties.dir}/${platform}.properties"/>
        <property file="${native.properties.dir}/native.properties"/>
        
        <!-- delete the locally cached file -->
        <delete dir="${scp.local.file}"/>
    </target>
    
    <!--
        This target cleans the java part of the project. It tries to execute the
        'clean' target on the project's build script. It does not really care if
        the target fails.
    -->
    <target name=".clean-java" depends="-init">
        <!-- run the 'clean' target on the project's build script -->
        <subant buildpath="${cvs.dir}" 
                target="${nb.target.clean}" 
                failonerror="false" 
                inheritall="false" 
                inheritrefs="false">
            <property name="${nb.platform.home.name}" 
                      value="${nb.platform.home.value}"/>
            <property name="${nb.ignore.native.name}" 
                      value="${nb.ignore.native.value}"/>
            <property name="${nb.no.dependencies.name}" 
                      value="${nb.no.dependencies.value}"/>
            <property name="skip.build.custom.tasks"
                      value="true"/>
            <property name="custom.tasks.cls" 
                      value="${custom.tasks.cls}"/>
        </subant>
    </target>
    
    <!-- =======================================================================
        Check out
    ======================================================================== -->
    <!-- 
        This is the main check out target, it just depends on two utility 
        targets - one checks out from trunk, the other from a branch. Each of 
        them has a execution condition attached.
    -->
    <target name="-checkout" 
            depends="-init,-pre-checkout,.co-trunk,.co-branch,.copy-sources"/>
    
    <!--
        A hook that allows executing something custom prior to checkout
    -->
    <target name="-pre-checkout"/>
    
    <!--
        Checks out the given sources from trunk.
    -->
    <target name=".co-trunk" if="do.checkout.trunk">
        <!-- run the cvs checkout command -->
        <cvs cvsroot="${cvs.root}" 
             command="checkout" 
             package="${cvs.module}/${cvs.path}" 
             dest="${work.dir}"
             failonerror="true"/>
    </target>
    
    <!--
        Checks out the given sources from a given branch.
    -->
    <target name=".co-branch" if="do.checkout.branch">
        <!-- run the cvs checkout command -->
        <cvs cvsroot="${cvs.root}" 
             command="checkout" 
             package="${cvs.module}/${cvs.path}" 
             tag="${cvs.branch}" 
             dest="${work.dir}"
             failonerror="true"/>
    </target>
    
    <!--
        Copies the sources from a given location
    -->
    <target name=".copy-sources" if="do.copy.sources">
        <mkdir dir="${work.dir}/${cvs.module}/${cvs.path}"/>
        
        <copy todir="${work.dir}/${cvs.module}/${cvs.path}" verbose="true">
            <fileset dir="${sources.dir}/${cvs.path}">
                <include name="**/*.*"/>
                <exclude name="**/nbproject/private/*.*"/>
                <exclude name="build/**/*.*"/>
                <exclude name="dist/**/*.*"/>
            </fileset>
        </copy>
    </target>
    
    <!-- =======================================================================
        Build
    ======================================================================== -->
    <!-- 
        This is the main build target, it invokes the check out procedure, then
        builds the native libraries for the project and finally the java part
        of it.
    -->
    <target name="-build" 
            depends="-init,-checkout,-pre-build,.build-native,.build-java"/>
    
    <!--
        A hook that allows executing something custom prior to build
    -->
    <target name="-pre-build"/>
    
    <!--
        Builds the mative libraries for the project. This target is only 
        executed if the ${build.native} property was set to 'true'. It iterates 
        over the list of platforms supplied via ${platforms} and calls the 
        utility target (which actually performs the build procedure) for each.
    -->
    <target name=".build-native" depends="-init" if="do.build.native">
        <for-each list="${platforms}" property="platform">
            <antcall target="..build-native"/>
        </for-each>
    </target>
    
    <!-- 
        Performs the native library build procedure for a given platform.
    -->
    <target name="..build-native">
        <!-- load properties pertaining to the given platform -->
        <property file="${native.properties.dir}/${platform}.properties"/>
        <property file="${native.properties.dir}/native.properties"/>
        
        <!-- run the ssh command - it is expected that it will build 
             everything -->
        <exec executable="${ssh.executable}" failonerror="true">
            <arg line="${ssh.arguments}"/>
            <arg value="${ssh.command}"/>
        </exec>
        
        <!-- run the scp command to copy the resulting file back to the 
             host system -->
        <mkdir dir="${scp.local.dir}"/>
        <exec executable="${scp.executable}" failonerror="true">
            <arg line="${scp.arguments}"/>
            <arg value="${scp.remote.dir}/${dist.file}"/>
            <arg value="${scp.local.dir}/${dist.file}"/>
        </exec>
    </target>
    
    <!--
        Builds the java part of the project. It simply invokes the 'build' 
        target on the project's build script. The target will fail if this 
        call's execution fails.
    -->
    <target name=".build-java" depends="init">
        <!-- run the 'build' target on the project's build script -->
        <echo message="!!!!! ${basedir}"/>
        <echo message="!!!!! ${cvs.dir}"/>
        <subant buildpath="${cvs.dir}" 
                target="${nb.target.build}" 
                failonerror="true" 
                inheritall="false" 
                inheritrefs="false">
            <property name="${nb.platform.home.name}" 
                      value="${nb.platform.home.value}"/>
            <property name="${nb.ignore.native.name}" 
                      value="${nb.ignore.native.value}"/>
            <property name="${nb.no.dependencies.name}" 
                      value="${nb.no.dependencies.value}"/>
            <property name="${nb.no.dependencies.name}" 
                      value="${nb.no.dependencies.value}"/>
            <property name="skip.build.custom.tasks"
                      value="true"/>
            <property name="custom.tasks.cls" 
                      value="${custom.tasks.cls}"/>
        </subant>
    </target>
    
    <!-- =======================================================================
        Default Target
    ======================================================================== -->
    <target name="usage">
        <echo>
            This build script is a targets library and should not be used 
            directly. See ../engine/build.xml and ../product/build.xml
            for usage examples.
        </echo>
    </target>
</project>
