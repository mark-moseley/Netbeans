/*
 *                 Sun Public License Notice
 *
 * The contents of this file are subject to the Sun Public License
 * Version 1.0 (the "License"). You may not use this file except in
 * compliance with the License. A copy of the License is available at
 * http://www.sun.com/
 *
 * The Original Code is NetBeans. The Initial Developer of the Original
 * Code is Sun Microsystems, Inc. Portions Copyright 1997-2004 Sun
 * Microsystems, Inc. All Rights Reserved.
 */

package org.netbeans.modules.websvc.core.client.wizard;

import java.io.File;
import java.util.Iterator;
import java.util.List;

import javax.swing.JPanel;
import javax.swing.JFileChooser;
import javax.swing.JRadioButton;
import javax.swing.filechooser.FileFilter;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.DefaultComboBoxModel;

import org.openide.DialogDescriptor;
import org.openide.DialogDisplayer;
import org.openide.NotifyDescriptor;
import org.openide.WizardDescriptor;
import org.openide.filesystems.FileUtil;
import org.openide.util.NbBundle;

import org.netbeans.api.project.Project;
import org.netbeans.api.project.ProjectUtils;
import org.netbeans.spi.project.ui.templates.support.Templates;

import org.netbeans.modules.web.api.webmodule.WebModule;
import org.netbeans.modules.web.spi.webmodule.WebModuleImplementation;

import org.netbeans.modules.websvc.api.webservices.WebServicesClientSupport;
import org.netbeans.modules.websvc.core.Utilities;

/**
 *
 * @author Peter Williams
 */
public final class ClientInfo extends JPanel implements WsdlRetriever.MessageReceiver {

    private static final String PROP_ERROR_MESSAGE = "WizardPanel_errorMessage"; // NOI18N
    
    private static final int WSDL_FROM_FILE = 1;
    private static final int WSDL_FROM_SERVICE = 2;
    
	private static final FileFilter WSDL_FILE_FILTER = new WsdlFileFilter();
	private static String previousDirectory = "";

	private WebServiceClientWizardDescriptor descriptorPanel;

    private boolean settingFields;
    private int wsdlSource;
    private File wsdlTmpFile;
    
    // properties for 'get from server'
    private WsdlRetriever retriever;
    private String downloadMsg;
    
	public ClientInfo(WebServiceClientWizardDescriptor panel) {
		descriptorPanel = panel;

        this.settingFields = false;
        this.wsdlSource = WSDL_FROM_SERVICE;
        this.wsdlTmpFile = null;
        this.retriever = null;

		initComponents();
		initUserComponents();
	}

	/** This method is called from within the constructor to
	 * initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is
	 * always regenerated by the Form Editor.
	 */
    private void initComponents() {//GEN-BEGIN:initComponents
        java.awt.GridBagConstraints gridBagConstraints;

        btnGrpWsdlSource = new javax.swing.ButtonGroup();
        jLblChooseSource = new javax.swing.JLabel();
        jRbnServiceURL = new javax.swing.JRadioButton();
        jTxtWsdlURL = new javax.swing.JTextField();
        jBtnGetWsdl = new javax.swing.JButton();
        jLblLocalFilename = new javax.swing.JLabel();
        jTxtLocalFilename = new javax.swing.JTextField();
        jBtnProxy = new javax.swing.JButton();
        jRbnFilesystem = new javax.swing.JRadioButton();
        jTxtWsdlFile = new javax.swing.JTextField();
        jBtnBrowse = new javax.swing.JButton();
        jLblProject = new javax.swing.JLabel();
        jTxtProject = new javax.swing.JTextField();
        jLblPackageName = new javax.swing.JLabel();
        jTxtPackageName = new javax.swing.JTextField();
        jLblClientType = new javax.swing.JLabel();
        jCbxClientType = new javax.swing.JComboBox();

        setLayout(new java.awt.GridBagLayout());

        jLblChooseSource.setText(NbBundle.getMessage(ClientInfo.class, "LBL_WsdlSource"));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 0, 4);
        add(jLblChooseSource, gridBagConstraints);

        btnGrpWsdlSource.add(jRbnServiceURL);
        jRbnServiceURL.setText(NbBundle.getMessage(ClientInfo.class, "LBL_WsdlSourceUrl"));
        jRbnServiceURL.setFocusable(false);
        jRbnServiceURL.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRbnServiceURLActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        add(jRbnServiceURL, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 4, 4);
        add(jTxtWsdlURL, gridBagConstraints);

        jBtnGetWsdl.setText(NbBundle.getMessage(ClientInfo.class, "LBL_RetrieveWsdl"));
        jBtnGetWsdl.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnGetWsdlActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 4, 4);
        add(jBtnGetWsdl, gridBagConstraints);

        jLblLocalFilename.setText(NbBundle.getMessage(ClientInfo.class, "LBL_LocalFilename"));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.insets = new java.awt.Insets(0, 21, 4, 4);
        add(jLblLocalFilename, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 4, 4);
        add(jTxtLocalFilename, gridBagConstraints);

        jBtnProxy.setText(NbBundle.getMessage(ClientInfo.class, "LBL_ProxySettings"));
        jBtnProxy.setFocusable(false);
        jBtnProxy.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnProxyActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 3;
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.EAST;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 0, 4);
        add(jBtnProxy, gridBagConstraints);

        btnGrpWsdlSource.add(jRbnFilesystem);
        jRbnFilesystem.setText(NbBundle.getMessage(ClientInfo.class, "LBL_WsdlSourceFilesystem"));
        jRbnFilesystem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jRbnFilesystemActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        add(jRbnFilesystem, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 0, 4);
        add(jTxtWsdlFile, gridBagConstraints);

        jBtnBrowse.setText(NbBundle.getMessage(ClientInfo.class, "LBL_Browse"));
        jBtnBrowse.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnBrowseActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 0, 4);
        add(jBtnBrowse, gridBagConstraints);

        jLblProject.setText(NbBundle.getMessage(ClientInfo.class, "LBL_Project"));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(8, 4, 0, 4);
        add(jLblProject, gridBagConstraints);

        jTxtProject.setEditable(false);
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 0, 4);
        add(jTxtProject, gridBagConstraints);

        jLblPackageName.setText(NbBundle.getMessage(ClientInfo.class, "LBL_PackageName"));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.insets = new java.awt.Insets(4, 4, 0, 4);
        add(jLblPackageName, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = java.awt.GridBagConstraints.REMAINDER;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(0, 4, 4, 4);
        add(jTxtPackageName, gridBagConstraints);

        jLblClientType.setText(NbBundle.getMessage(ClientInfo.class, "LBL_ClientType"));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.ipady = 4;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTH;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(4, 4, 4, 4);
        add(jLblClientType, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTH;
        gridBagConstraints.insets = new java.awt.Insets(4, 4, 4, 4);
        add(jCbxClientType, gridBagConstraints);

    }//GEN-END:initComponents

    private void jBtnProxyActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnProxyActionPerformed
        ProxySettingsDlg.showProxyDlg();
    }//GEN-LAST:event_jBtnProxyActionPerformed

    private void jBtnGetWsdlActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnGetWsdlActionPerformed
//        System.out.println("get WSDL from server...");
        jTxtWsdlURL.setEditable(false);
        retriever = new WsdlRetriever(this, jTxtWsdlURL.getText().trim());
        new Thread(retriever).start();
    }//GEN-LAST:event_jBtnGetWsdlActionPerformed

	private void jBtnBrowseActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnBrowseActionPerformed
// 		System.out.println("browse for wsdl file...");
        JFileChooser chooser = new JFileChooser(previousDirectory);
		chooser.setMultiSelectionEnabled(false);
		chooser.setAcceptAllFileFilterUsed(false);
		chooser.addChoosableFileFilter(WSDL_FILE_FILTER);
		chooser.setFileFilter(WSDL_FILE_FILTER);

		if(chooser.showOpenDialog(this) == JFileChooser.APPROVE_OPTION) {
			File wsdlFile = chooser.getSelectedFile();
			jTxtWsdlFile.setText(wsdlFile.getAbsolutePath());
			previousDirectory = wsdlFile.getPath();
		}
	}//GEN-LAST:event_jBtnBrowseActionPerformed

    private void jRbnFilesystemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRbnFilesystemActionPerformed
//        System.out.println("get from filesystem selected.");
        wsdlSource = WSDL_FROM_FILE;
        enableWsdlSourceFields(false, true);
        descriptorPanel.fireChangeEvent();
    }//GEN-LAST:event_jRbnFilesystemActionPerformed

	private void jRbnServiceURLActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jRbnServiceURLActionPerformed
//        System.out.println("get from url selected.");
        wsdlSource = WSDL_FROM_SERVICE;
        enableWsdlSourceFields(true, false);
        descriptorPanel.fireChangeEvent();
	}//GEN-LAST:event_jRbnServiceURLActionPerformed

    private void enableWsdlSourceFields(boolean fromService, boolean fromFile) {
        // file related fields
        jTxtWsdlFile.setEnabled(fromFile);
        jBtnBrowse.setEnabled(fromFile);
        
        // service related fields
        jTxtWsdlURL.setEnabled(fromService);
        String wsdlUrlText = jTxtWsdlURL.getText().trim();
        jBtnGetWsdl.setEnabled(fromService && isValidUrl(wsdlUrlText));
        jBtnProxy.setEnabled(fromService);
        jLblLocalFilename.setEnabled(fromService);
        jTxtLocalFilename.setEnabled(fromService);
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup btnGrpWsdlSource;
    private javax.swing.JButton jBtnBrowse;
    private javax.swing.JButton jBtnGetWsdl;
    private javax.swing.JButton jBtnProxy;
    private javax.swing.JComboBox jCbxClientType;
    private javax.swing.JLabel jLblChooseSource;
    private javax.swing.JLabel jLblClientType;
    private javax.swing.JLabel jLblLocalFilename;
    private javax.swing.JLabel jLblPackageName;
    private javax.swing.JLabel jLblProject;
    private javax.swing.JRadioButton jRbnFilesystem;
    private javax.swing.JRadioButton jRbnServiceURL;
    private javax.swing.JTextField jTxtLocalFilename;
    private javax.swing.JTextField jTxtPackageName;
    private javax.swing.JTextField jTxtProject;
    private javax.swing.JTextField jTxtWsdlFile;
    private javax.swing.JTextField jTxtWsdlURL;
    // End of variables declaration//GEN-END:variables

	private void initUserComponents() {
//        System.out.println("wizard panel created");
		setName(NbBundle.getMessage(ClientInfo.class, "TITLE_WebServiceClientWizard")); // NOI18N

		// Register listener on the textFields to make the automatic updates
        jTxtWsdlURL.getDocument().addDocumentListener(new DocumentListener() {
                public void changedUpdate(DocumentEvent e) {
                    wsdlUrlChanged();
                }
                public void insertUpdate(DocumentEvent e) {
                    wsdlUrlChanged();
                }
                public void removeUpdate(DocumentEvent e) {
                    wsdlUrlChanged();
                }
            });
        jTxtLocalFilename.getDocument().addDocumentListener(new DocumentListener() {
                public void changedUpdate(DocumentEvent e) {
                    updateTexts();
                }
                public void insertUpdate(DocumentEvent e) {
                    updateTexts();
                }
                public void removeUpdate(DocumentEvent e) {
                    updateTexts();
                }
            });
        jTxtWsdlFile.getDocument().addDocumentListener(new DocumentListener() {
                public void changedUpdate(DocumentEvent e) {
                    updateTexts();
                }
                public void insertUpdate(DocumentEvent e) {
                    updateTexts();
                }
                public void removeUpdate(DocumentEvent e) {
                    updateTexts();
                }
            });
        jTxtPackageName.getDocument().addDocumentListener(new DocumentListener() {
                public void changedUpdate(DocumentEvent e) {
                    updateTexts();
                }
                public void insertUpdate(DocumentEvent e) {
                    updateTexts();
                }
                public void removeUpdate(DocumentEvent e) {
                    updateTexts();
                }
            });
	}
    
    void store(WizardDescriptor d) {
//        System.out.println("storing wizard properties");

        if(wsdlSource == WSDL_FROM_SERVICE) {
            d.putProperty(WizardProperties.WSDL_DOWNLOAD_URL, getDownloadUrl());
            d.putProperty(WizardProperties.WSDL_DOWNLOAD_FILE, getDownloadWsdl());
            d.putProperty(WizardProperties.WSDL_FILE_PATH, jTxtLocalFilename.getText().trim());
        } else if(wsdlSource == WSDL_FROM_FILE) {
            d.putProperty(WizardProperties.WSDL_DOWNLOAD_URL, null);
            d.putProperty(WizardProperties.WSDL_DOWNLOAD_FILE, null);
            d.putProperty(WizardProperties.WSDL_FILE_PATH, jTxtWsdlFile.getText().trim());
        }
        d.putProperty(WizardProperties.WSDL_PACKAGE_NAME, jTxtPackageName.getText().trim());
        d.putProperty(WizardProperties.CLIENT_STUB_TYPE, jCbxClientType.getSelectedItem());
	}
    
    void read(WizardDescriptor d) {
//        System.out.println("reading wizard properties");
        try {
            settingFields = true;
            
            Project p = Templates.getProject(d);

            jTxtProject.setText(ProjectUtils.getInformation(p).getDisplayName());
            jTxtWsdlURL.setText((String) d.getProperty(WizardProperties.WSDL_DOWNLOAD_URL));
            jTxtLocalFilename.setText(retriever != null ? retriever.getWsdlFileName() : "");
            jTxtWsdlFile.setText((String) d.getProperty(WizardProperties.WSDL_FILE_PATH));
            jTxtPackageName.setText((String) d.getProperty(WizardProperties.WSDL_PACKAGE_NAME));

            // Normalize selection, in case it's unspecified.
            Integer source = (Integer) d.getProperty(WizardProperties.WSDL_SOURCE);
            if(source == null || source.intValue() < WSDL_FROM_SERVICE || source.intValue() > WSDL_FROM_FILE) {
                source = new Integer(WSDL_FROM_SERVICE);
            }

            this.wsdlSource = source.intValue();
            this.wsdlTmpFile = null;
            this.retriever = null;
            this.downloadMsg = null;

            enableWsdlSourceFields(wsdlSource == WSDL_FROM_SERVICE, wsdlSource == WSDL_FROM_FILE);
            btnGrpWsdlSource.setSelected(getSelectedRadioButton(wsdlSource).getModel(), true);

            // Retrieve stub list from current project (have to be careful with caching
            // because the user might go back and change the project.)
            // Then set the stub list and current selected stub only if there was one
            // saved *and* it's in the list that the current project supports.
            WebServicesClientSupport clientSupport =
                WebServicesClientSupport.getWebServicesClientSupport(p.getProjectDirectory());

            Object selectedStub = d.getProperty(WizardProperties.CLIENT_STUB_TYPE);
            DefaultComboBoxModel stubModel = new DefaultComboBoxModel();
            if(clientSupport != null) {
                List clientStubs = clientSupport.getStubDescriptors();
                for(Iterator iter = clientStubs.iterator(); iter.hasNext(); ) {
                    stubModel.addElement(iter.next());
                }

                if(!clientStubs.contains(selectedStub)) {
                    selectedStub = null;
                }
            } else {
                selectedStub = null;
            }

            jCbxClientType.setModel(stubModel);

            if(selectedStub != null) {
                jCbxClientType.setSelectedItem(selectedStub);
            }
        } finally {
            settingFields = false;
        }
	}

	private JRadioButton getSelectedRadioButton(int selected) {
        JRadioButton result = jRbnServiceURL;
        
        switch(selected) {
        case WSDL_FROM_FILE:
            result = jRbnFilesystem;
            break;
        case WSDL_FROM_SERVICE:
            result = jRbnServiceURL;
            break;
        }
        
        return result;
    }

    private String getDownloadWsdl() {
        String result = null;
        if(retriever != null && retriever.getState() == WsdlRetriever.STATUS_COMPLETE) {
            result = retriever.getWsdl();
        }
        return result;
    }
    
    private String getDownloadUrl() {
        String result;
        
        if(retriever != null) {
            // If we've done a download, save the URL that was actually used, not
            // what the user typed in.
            result = retriever.getWsdlUrl();
        } else {
            // If no download yet, then use what the user has typed.
            result = jTxtWsdlURL.getText().trim();
        }
        
        return result;
    }

	boolean valid(WizardDescriptor wizardDescriptor) {
//        System.out.println("validating wizard properties");
		// !PW 50047 - for EA1 (JSR-109 only) wizard is only valid if the project
		// supports Servlet 2.4 (and thus J2EE 1.4).
		Project p = Templates.getProject(wizardDescriptor);
		// !PW FIXME this lookup call will need to be updated for freeform projects in EA2.
		WebModuleImplementation wm = (WebModuleImplementation) p.getLookup().lookup(WebModuleImplementation.class);
		if(WebModule.J2EE_13_LEVEL.equals(wm.getJ2eePlatformVersion())) {
			wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "ERR_ClientNotSupported")); // NOI18N
			return false; // servlet 2.3/j2ee 1.3 webapp project
		}

        // Project selected must support at least one stub type.
        WebServicesClientSupport clientSupport =
            WebServicesClientSupport.getWebServicesClientSupport(p.getProjectDirectory());
        List clientStubs = (clientSupport != null) ? clientSupport.getStubDescriptors() : null;
        if(clientStubs == null || clientStubs.size() == 0) {
			wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "ERR_NoStubsDefined")); // NOI18N
			return false; // project with web service client support, but no stub types defined.
        }

        if(wsdlSource == WSDL_FROM_SERVICE) {
            String wsdlUrl = jTxtWsdlURL.getText().trim();
            if(wsdlUrl == null || wsdlUrl.length() == 0) {
                wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "MSG_EnterURL")); // NOI18N
                return false;
            }
            
            if(retriever == null) {
                wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "MSG_RetrieveWSDL")); // NOI18N
                return false;
            }
            
            if(retriever.getState() < WsdlRetriever.STATUS_COMPLETE) {
                wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "MSG_DownloadProgress",  // NOI18N
                    ((downloadMsg != null) ? downloadMsg : NbBundle.getMessage(ClientInfo.class, "LBL_Unknown")))); // NOI18N
                return false;
            }
            
            if(retriever.getState() > WsdlRetriever.STATUS_COMPLETE) {
                if(downloadMsg != null) {
                    wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "ERR_DownloadFailed", downloadMsg)); // NOI18N
                } else {
                    wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "ERR_DownloadFailedUnknown")); // NOI18N
                }
                return false;
            }
            
            // url is ok, and file is downloaded if we get here.  Now check generated local filename
            // !PW FIXME what do we want to check it for?  Existence in temp directory?
            
            // Now drop down to do package validation.
        } else if(wsdlSource == WSDL_FROM_FILE) {
            String wsdlFilePath = jTxtWsdlFile.getText().trim();

            if(wsdlFilePath == null || wsdlFilePath.length() == 0) {
                wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "MSG_EnterFilename")); // NOI18N
                return false; // unspecified WSDL file
            }

            File f = new File(wsdlFilePath);
            String wsdlFileText = f.getAbsolutePath();
            if(f == null) {
                wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "ERR_WsdlInvalid")); // NOI18N
                return false; // invalid WSDL file
            }

            if(!f.exists()) {
                wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "ERR_WsdlDoesNotExist")); // NOI18N
                return false; // invalid WSDL file
            }

            // !PW FIXME should also detect if WSDL file has previously been added to
            // this project.  Note that not doing so and overwriting the existing entry
            // is the equivalent of doing an update on it.  Nothing bad will happen
            // unless it turns out the user didn't want to update the service in the
            // first place.
        }

		String packageName = jTxtPackageName.getText().trim();

		if(packageName == null || packageName.length() == 0) {
			wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "MSG_EnterJavaPackageName")); // NOI18N
			return false; // unspecified WSDL file
		}

		if(!Utilities.isJavaPackage(packageName)) {
			wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, NbBundle.getMessage(ClientInfo.class, "ERR_PackageInvalid")); // NOI18N
			return false; // invalid package name
		}

		wizardDescriptor.putProperty(PROP_ERROR_MESSAGE, "");
		return true;
	}
    
    private void wsdlUrlChanged() {
        // Throw away any existing retriever.  New URL means user has to download it again.
        retriever = null;
        
        // Only enable retrieval button if there is a URL specified.
        String wsdlUrlText = jTxtWsdlURL.getText().trim();
        jBtnGetWsdl.setEnabled(isValidUrl(wsdlUrlText));
        
        updateTexts();
    }
    
    private void updateTexts() {
        if(!settingFields) {
            descriptorPanel.fireChangeEvent(); // Notify that the panel changed
        }
    }
    
    private boolean isValidUrl(String urlText) {
        if(urlText == null || urlText.length() == 0) {
            return false;
        }
        
        // !PW Be very careful adding conditions to this method (such as seeing if
        // conversion of url text to URL would throw a MalformedURLException and
        // reporting it to the user early.)  It is a non-trivial change that would
        // require significant synchronization with code in the retriever object.
        // as well as the valid() method of this object.  See IZ 52685.
        return true;
    }
    
    public void setWsdlDownloadMessage(String m) {
        downloadMsg = m;
        
        // reenable edit control if state indicates download is completed (or failed).
        if(retriever.getState() >= WsdlRetriever.STATUS_COMPLETE) {
            jTxtWsdlURL.setEditable(true);
            jTxtLocalFilename.setText(retriever.getWsdlFileName());
        }
        
        descriptorPanel.fireChangeEvent();
    }

	private static class WsdlFileFilter extends FileFilter {
		public boolean accept(File f) {
			boolean result;
			if(f.isDirectory() || "wsdl".equalsIgnoreCase(FileUtil.getExtension(f.getName()))) { // NOI18N
				result = true;
			} else {
				result = false;
			}
			return result;
		}

		public String getDescription() {
			return NbBundle.getMessage(ClientInfo.class, "LBL_WsdlFilterDescription"); // NOI18N
		}
	}
}
