<?xml version="1.0" encoding="UTF-8"?><!-- -*- sgml-indent-step: 2 -*- -->
<!--
                Sun Public License Notice

The contents of this file are subject to the Sun Public License
Version 1.0 (the "License"). You may not use this file except in
compliance with the License. A copy of the License is available at
http://www.sun.com/

The Original Code is NetBeans. The Initial Developer of the Original
Code is Sun Microsystems, Inc. Portions Copyright 1997-2002 Sun
Microsystems, Inc. All Rights Reserved.

Contributor(s): Jayme C. Edwards, Jesse Glick.
-->

<project name="ant" default="netbeans" basedir=".">

  <property name="homepage.base" value="netbeans.org"/>
  <property name="dist.base" value="www.netbeans.org/download/nbms/40"/>
  <property name="license.file" location="../nbbuild/standard-nbm-license.txt"/>

  <property name="nbm_alias" value="nb_ide"/>

  <taskdef name="makenbm" classname="org.netbeans.nbbuild.MakeNBM" classpath="../nbbuild/nbantext.jar"/>
  <taskdef name="locjar" classname="org.netbeans.nbbuild.LocalizedJar" classpath="../nbbuild/nbantext.jar"/>
  <taskdef name="genlist" classname="org.netbeans.nbbuild.MakeListOfNBM" classpath="../nbbuild/nbantext.jar"/>

  <target name="init">
    <ant dir="external" target="unscramble"/>
  </target>

  <target name="compile" depends="init">
    <javac srcdir="src" destdir="src" deprecation="${build.compiler.deprecation}" debug="${build.compiler.debug}">
      <classpath>
        <pathelement location="../openide/openide-13javac-workaround.jar"/>
        <pathelement location="../openide/netbeans/lib/openide.jar"/>
        <pathelement location="../openide/deprecated/netbeans/modules/autoload/openide-deprecated.jar"/> <!-- XXX -->
        <fileset dir="external">
          <include name="ant-1.*.jar"/>
        </fileset>
        <fileset dir="../core/external">
          <include name="xml-apis*.jar"/>
          <include name="xerces*.jar"/>
        </fileset>
        <pathelement location="../core/javahelp/netbeans/modules/autoload/javahelp-api.jar"/>
      </classpath>
    </javac>
  </target>

  <target name="jars" depends="compile">
    <mkdir dir="netbeans/modules"/>
    <filter token="BUILD_NUMBER_SUBST" value="${buildnumber}"/>
    <copy file="manifest.mf" tofile="manifest-subst.mf" filtering="on"/>
    <locjar jarfile="netbeans/modules/ant.jar"
         manifest="manifest-subst.mf"
         basedir="src"
	 excludesfile="../nbbuild/standard-jar-excludes.txt"
	 compress="false">
      <locale name="ja"/>
    </locjar>
  </target>

  <target name="release" depends="init">
    <copy todir="netbeans" includeEmptyDirs="false">
      <fileset dir="release" excludesfile="../nbbuild/standard-jar-excludes.txt"/>
    </copy>
    <mkdir dir="netbeans/modules/ext"/>
    <copy todir="netbeans/modules/ext">
      <fileset dir="external">
        <include name="ant*.jar"/>
      </fileset>
    </copy>
  </target>

  <target name="netbeans" depends="jars,release" description="Build module.">
    <genlist targetname="nbm" outputfiledir="../nbbuild/netbeans"/>
  </target>

  <target name="nbm" depends="netbeans" description="Build module NBM file.">
    <makenbm file="ant.nbm"
             topdir="."
             module="netbeans/modules/ant.jar"
	     homepage="http://ant.${homepage.base}/"
	     distribution="http://${dist.base}/ant.nbm">
      <license name="ant-license.txt">
        <text>For the Ant module itself:</text>
        <file location="${license.file}"/>
	<text>For the Ant runtime:</text>
	<file location="../nbbuild/external/apache-license.txt"/>
      </license>
      <signature keystore="${keystore}" storepass="${storepass}" alias="${nbm_alias}"/>
    </makenbm>
  </target>

  <target name="test-build" depends="compile">
    <mkdir dir="reload"/>
    <filter token="BUILD_NUMBER_SUBST" value="testing"/>
    <copy file="manifest.mf" tofile="manifest-subst.mf" filtering="on"/>
    <jar jarfile="reload/ant.jar" manifest="manifest-subst.mf" compress="false">
      <fileset dir="src" excludesfile="../nbbuild/standard-jar-excludes.txt"/>
      <zipfileset src="external/ant-1.4.1.jar" excludes="META-INF/MANIFEST.MF"/>
      <zipfileset src="external/ant-optional-1.4.1.jar" excludes="META-INF/MANIFEST.MF"/>
    </jar>
  </target>
  <target name="test" depends="test-build" description="Test module inside running IDE.">
    <nbinstaller module="reload/ant.jar" action="reinstall"/>
  </target>

  <target name="clean" description="Clean out build products.">
    <delete>
      <fileset dir="src">
        <include name="**/*.class"/>
      </fileset>
    </delete>
    <delete file="manifest-subst.mf"/>
    <delete file="ant.nbm"/>
    <delete dir="netbeans"/>
    <delete dir="Info"/>
    <delete dir="AntAPIs"/>
    <delete file="AntAPIs.zip"/>
    <delete dir="javadoc"/>
    <!-- See target 'release-helper': -->
    <delete dir="release-work"/>
  </target>

  <target name="real-clean" depends="clean">
    <delete dir="reload"/>
  </target>

  <!-- For use when making new releases: -->
  <target name="ensure-def-release-sourcepath" unless="release-sourcepath">
    <fail message="You must define the variable release-sourcepath: should be root of jakarta-ant checkout"/>
  </target>
  <target name="ensure-def-release-version" unless="release-version">
    <fail message="You must define the variable release-version: e.g. 1.4"/>
  </target>
  <target name="release-helper" depends="ensure-def-release-sourcepath,ensure-def-release-version" description="Help do some things useful when bundling a new Ant release.">
    <property name="release-source-root" location="${release-sourcepath}/src/main"/>
    <echo>1.  Will create a snapshot of "useful" Java sources from ${release-source-root}...</echo>
    <property name="useful-sources" location="release-work/useful-sources"/>
    <delete dir="${useful-sources}"/>
    <mkdir dir="${useful-sources}"/>
    <copy todir="${useful-sources}">
      <fileset dir="${release-source-root}">
        <!-- Necessarily chosen according to personal judgement; there is no official guide here: -->
        <include name="org/apache/tools/ant/*.java"/>
        <exclude name="org/apache/tools/ant/Launcher.java"/>
        <exclude name="org/apache/tools/ant/Main.java"/>
        <include name="org/apache/tools/ant/listener/*.java"/>
        <include name="org/apache/tools/ant/taskdefs/Ant.java"/>
        <include name="org/apache/tools/ant/taskdefs/Definer.java"/>
        <include name="org/apache/tools/ant/taskdefs/Execute.java"/>
        <include name="org/apache/tools/ant/taskdefs/ExecuteJava.java"/>
        <include name="org/apache/tools/ant/taskdefs/ExecuteStreamHandler.java"/>
        <include name="org/apache/tools/ant/taskdefs/ExecuteWatchdog.java"/>
        <include name="org/apache/tools/ant/taskdefs/Javac.java"/>
        <include name="org/apache/tools/ant/taskdefs/MatchingTask.java"/>
        <include name="org/apache/tools/ant/taskdefs/Property.java"/>
        <include name="org/apache/tools/ant/taskdefs/Rmic.java"/>
        <include name="org/apache/tools/ant/taskdefs/compilers/CompilerAdapter.java"/>
        <include name="org/apache/tools/ant/taskdefs/compilers/DefaultCompilerAdapter.java"/>
        <include name="org/apache/tools/ant/taskdefs/rmic/DefaultRmicAdapter.java"/>
        <include name="org/apache/tools/ant/taskdefs/rmic/RmicAdapter.java"/>
        <include name="org/apache/tools/ant/types/*.java"/>
        <include name="org/apache/tools/ant/util/*.java"/>
        <include name="org/apache/tools/ant/util/regexp/RegexpMatcher.java"/>
        <include name="org/apache/tools/ant/util/regexp/RegexpMatcherFactory.java"/>
        <!-- Do not forget about the package list for Javadoc below... -->
      </fileset>
    </copy>
    <property name="ant-api.zip" location="docs/release/docs/ant-api.zip"/>
    <echo>2.  Will produce Javadoc for these at ${ant-api.zip}...</echo>
    <property name="javadoc-out" location="release-work/javadoc-out"/>
    <delete dir="${javadoc-out}"/>
    <mkdir dir="${javadoc-out}"/>
    <javadoc
      packagenames="org.apache.tools.ant.*,org.apache.tools.ant.listener.*,org.apache.tools.ant.taskdefs.*,org.apache.tools.ant.taskdefs.compilers.*,org.apache.tools.ant.taskdefs.rmic.*,org.apache.tools.ant.types.*,org.apache.tools.ant.util.*,org.apache.tools.ant.util.regexp.*"
      destdir="${javadoc-out}"
      protected="true"
      windowtitle="Ant ${release-version} Javadoc - Essential Classes"
      doctitle="Ant ${release-version} Javadoc - Essential Classes"
      version="false"
      use="false"
      author="false"
      splitindex="false"
      nodeprecatedlist="true"
      notree="true"
      nohelp="true"
      failonerror="true"
      bottom="&lt;font size=&quot;-2&quot; color=&quot;gray&quot;&gt;Includes only those classes commonly used by task writers. The Ant ${release-version} distribution includes complete Javadoc for all classes included in Ant, though in most cases these are not intended as APIs.&lt;/font&gt;"
      >
      <sourcepath>
        <pathelement location="${useful-sources}"/>
      </sourcepath>
      <classpath>
        <fileset dir="../core/external">
          <include name="xml-apis*.jar"/>
          <include name="xerces*.jar"/>
        </fileset>
      </classpath>
    </javadoc>
    <delete file="${ant-api.zip}"/>
    <zip zipfile="${ant-api.zip}">
      <fileset dir="${javadoc-out}"/>
    </zip>
    <property name="orig-manual" location="${release-sourcepath}/docs/manual"/>
    <echo>3.  Doing some preparation of the Ant manual, taken from ${orig-manual}...</echo>
    <property name="online-manual" location="release-work/online-manual"/>
    <delete dir="${online-manual}"/>
    <mkdir dir="${online-manual}"/>
    <copy todir="${online-manual}">
      <fileset dir="${orig-manual}" excludesfile="../nbbuild/standard-jar-excludes.txt">
        <!-- These are obviated by JavaHelp: -->
        <exclude name="coretasklist.html"/>
        <exclude name="optionaltasklist.html"/>
        <exclude name="index.html"/>
        <exclude name="toc.html"/>
        <!-- Presumably you do not care about other IDE integrations at this point: -->
        <exclude name="ide.html"/>
        <exclude name="Integration/"/>
        <!-- Does not apply inside NetBeans: -->
        <exclude name="running.html"/>
        <!-- Included as a separate Javadoc mount: -->
        <exclude name="api/"/>
      </fileset>
    </copy>
    <move file="${online-manual}/install.html" tofile="${online-manual}/libdeps.html"/>
    <property name="libdeps.html" location="${online-manual}/libdeps.html"/>
    <property name="ant-docs.zip" location="external/ant-docs-${release-version}.zip"/>
    <property name="here" location="."/>
    <property name="ParserDB" location="docs/release/system/ParserDB"/>
    <property name="features.xml" location="www/plans/features.xml"/>
    <property name="ant.jar" location="external/ant-${release-version}.jar"/>
    <property name="ant-optional.jar" location="external/ant-optional-${release-version}.jar"/>
    <echo>Now some (currently) manual steps for you:
4.  Edit ${libdeps.html}:
    - remove everything but Library Dependencies
    - libraries are needed not in classpath, but NBINSTALL/modules/patches/org-apache-tools-ant-module/
    - Jakarta regexp is already available in the IDE by default
5.  Recreate ${ant-docs.zip}.master from the contents of ${online-manual}
6.  Ensure these files in ${here} match the actual contents of ${online-manual}:
    - docs/javahelp/org/apache/tools/ant/module/docs/TOC.toc
    - docs/javahelp/org/apache/tools/ant/module/docs/Map.jhm
7.  Mention that the Ant version is ${release-version} in these files in ${here}:
    - docs/javahelp/org/apache/tools/ant/module/docs/HelpSet.hs
    - docs/javahelp/org/apache/tools/ant/module/docs/TOC.toc
    - docs/src/org/apache/tools/ant/module/docs/Bundle.properties
    - src/org/apache/tools/ant/module/resources/SampleProject.xml_
    - src/org/apache/tools/ant/module/resources/CustomTask_java
    - ../usersguide/javahelp/org/netbeans/modules/usersguide/ant/*.html
8.  Update ${ParserDB} with sources from ${useful-sources}
9.  Update ${features.xml}
10. Refresh these files with the prebuilt binaries from an Ant download:
    - ${ant.jar}.master
    - ${ant-optional.jar}.master
    (and scramble them by running 'scramble in external/build.xml)
11. Test everything
12. Submit a patch for cvs://cvs.apache.org/jakarta-ant/xdocs/external.xml
    mentioning that the bundled version in NB is now ${release-version}.

After that you should be done!
</echo>
  </target>

    <target name="apichanges-check" description="Check syntax of API changes list. Requires Ant 1.4!">
        <xmlvalidate file="api/doc/changes/apichanges.xml" failonerror="true"/>
    </target>
    <target name="apichanges-generate" description="Regenerate HTML from XML API changes list.">
        <style in="api/doc/changes/apichanges.xml" out="www/apichanges.html" destdir="www" style="../openide/api/doc/changes/apichanges.xsl"/>
    </target>

    <target name="ant-module-javadoc">
        <property name="jdk-docs-location" value="http://java.sun.com/j2se/1.3/docs/api"/>
        <property name="openide-docs-location" value="http://www.netbeans.org/download/apis/"/>
        <echo message="Build Ant API documentation..."/>
        <delete dir="AntAPIs"/>
        <mkdir dir="AntAPIs"/>
        <javadoc destdir="AntAPIs"
             packagenames="org.netbeans.api.*,org.netbeans.spi.*,org.apache.tools.ant.module.api.*"
             doctitle="NetBeans module ant APIs"
             use="true"
             splitindex="true"
             author="false"
             version="false"
             maxmemory="64m"
        >
          <sourcepath>
            <pathelement location="src"/>
          </sourcepath>
          <classpath>
            <pathelement location="../openide/openide-13javac-workaround.jar"/>
            <fileset dir="../openide/netbeans/lib">
              <include name="openide*.jar" />
            </fileset>
            <fileset dir="external">
              <include name="ant.jar"/>
              <include name="ant-1.*.jar"/>
            </fileset>
            <fileset dir="../core/external">
              <include name="xml-apis*.jar"/>
              <include name="xerces*.jar"/>
            </fileset>
            <pathelement location="../core/javahelp/netbeans/modules/autoload/javahelp-api.jar"/>
          </classpath>
          <link href="${jdk-docs-location}"
                offline="true"
                packagelistLoc="${nbroot}/openide/api/doc"
          />
          <link href="${openide-docs-location}"
                offline="true"
                packagelistLoc="api/doc/openide"
          />
        </javadoc>
        <zip zipfile="AntAPIs.zip" basedir="AntAPIs"/>
    </target>

    <target name="javadoc" depends="ant-module-javadoc">
      <copy todir="javadoc">
        <fileset dir=".">
          <include name="AntAPIs/**"/>
          <include name="AntAPIs.zip"/>
        </fileset>
      </copy>
    </target>

</project>
