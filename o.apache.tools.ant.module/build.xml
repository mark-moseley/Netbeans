<?xml version="1.0" encoding="UTF-8"?><!-- -*- sgml-indent-step: 2 -*- -->
<!--
                Sun Public License Notice

The contents of this file are subject to the Sun Public License
Version 1.0 (the "License"). You may not use this file except in
compliance with the License. A copy of the License is available at
http://www.sun.com/

The Original Code is NetBeans. The Initial Developer of the Original
Code is Sun Microsystems, Inc. Portions Copyright 1997-2003 Sun
Microsystems, Inc. All Rights Reserved.

Contributor(s): Jayme C. Edwards, Jesse Glick.
-->

<project name="ant" default="netbeans" basedir=".">

  <property name="homepage.base" value="netbeans.org"/>
  <property name="dist.base" value="www.netbeans.org/download/nbms/40"/>
  <property name="license.file" location="../nbbuild/standard-nbm-license.txt"/>

  <property name="nbm_alias" value="nb_ide"/>

  <taskdef name="makenbm" classname="org.netbeans.nbbuild.MakeNBM" classpath="../nbbuild/nbantext.jar"/>
  <taskdef name="locjar" classname="org.netbeans.nbbuild.LocalizedJar" classpath="../nbbuild/nbantext.jar"/>
  <taskdef name="genlist" classname="org.netbeans.nbbuild.MakeListOfNBM" classpath="../nbbuild/nbantext.jar"/>

  <target name="init">
    <ant dir="external" target="unscramble"/>
  </target>
  
  <path id="cp">
    <pathelement location="../openide/openide-13javac-workaround.jar"/>
    <pathelement location="../openide/netbeans/lib/openide.jar"/>
    <pathelement location="../openide/loaders/netbeans/lib/openide-loaders.jar"/>
    <pathelement location="../openide/compiler/netbeans/modules/autoload/openide-compiler.jar"/>
    <pathelement location="../openide/execution/netbeans/modules/autoload/openide-execution.jar"/>
    <pathelement location="../openide/io/netbeans/modules/autoload/openide-io.jar"/>
    <pathelement location="../java/api/netbeans/modules/autoload/java-api.jar"/>
    <fileset dir="../libs/external">
      <include name="xerces*.jar"/>
    </fileset>
    <pathelement location="../core/javahelp/netbeans/modules/autoload/javahelp-api.jar"/>
  </path>

  <path id="cp+ant">
    <path refid="cp"/>
    <pathelement location="src"/>
    <fileset dir="external">
      <include name="ant-1.*.jar"/>
    </fileset>
  </path>

  <target name="compile" depends="init">
    <javac srcdir="src" destdir="src" deprecation="${build.compiler.deprecation}" debug="${build.compiler.debug}" source="1.4">
      <classpath refid="cp"/>
    </javac>
    <javac srcdir="src-bridge" destdir="src-bridge" deprecation="${build.compiler.deprecation}" debug="${build.compiler.debug}">
      <classpath refid="cp+ant"/>
    </javac>
  </target>

  <target name="jars" depends="compile">
    <mkdir dir="netbeans/modules"/>
    <filter token="BUILD_NUMBER_SUBST" value="${buildnumber}"/>
    <copy file="manifest.mf" tofile="manifest-subst.mf" filtering="on"/>
    <locjar jarfile="netbeans/modules/ant.jar"
         manifest="manifest-subst.mf"
         basedir="src"
	 excludesfile="../nbbuild/standard-jar-excludes.txt"
	 compress="false">
      <locale name="ja"/>
    </locjar>
    <mkdir dir="netbeans/ant/nblib"/>
    <jar jarfile="netbeans/ant/nblib/bridge.jar" compress="false">
      <fileset dir="src-bridge">
        <excludesfile name="../nbbuild/standard-jar-excludes.txt"/>
      </fileset>
    </jar>
  </target>

  <target name="release" depends="init">
    <mkdir dir="netbeans/ant/lib"/>
    <copy file="external/ant-1.5.3.jar" tofile="netbeans/ant/lib/ant.jar"/>
    <copy file="external/ant-optional-1.5.3.jar" tofile="netbeans/ant/lib/optional.jar"/>
  </target>

  <target name="netbeans" depends="jars,release" description="Build module.">
    <genlist targetname="nbm" outputfiledir="netbeans"/>
  </target>

  <target name="nbm" depends="netbeans" description="Build module NBM file.">
    <makenbm file="ant.nbm"
             topdir="."
             module="netbeans/modules/ant.jar"
	     homepage="http://ant.${homepage.base}/"
	     distribution="http://${dist.base}/ant.nbm">
      <license name="ant-license.txt">
        <text>For the Ant module itself:</text>
        <file location="${license.file}"/>
	<text>For the Ant runtime:</text>
	<file location="../nbbuild/external/apache-license.txt"/>
      </license>
      <signature keystore="${keystore}" storepass="${storepass}" alias="${nbm_alias}"/>
    </makenbm>
  </target>

  <target name="test-build" depends="compile">
    <mkdir dir="reload"/>
    <filter token="BUILD_NUMBER_SUBST" value="testing"/>
    <copy file="manifest.mf" tofile="manifest-subst.mf" filtering="on"/>
    <jar jarfile="reload/ant.jar" manifest="manifest-subst.mf" compress="false">
      <fileset dir="src" excludesfile="../nbbuild/standard-jar-excludes.txt"/>
    </jar>
  </target>
  <target name="test" depends="test-build" description="Test module inside running IDE.">
    <nbinstaller module="reload/ant.jar" action="reinstall"/>
  </target>

  <target name="clean" description="Clean out build products.">
    <delete>
      <fileset dir="src">
        <include name="**/*.class"/>
      </fileset>
    </delete>
    <delete file="manifest-subst.mf"/>
    <delete file="ant.nbm"/>
    <delete dir="netbeans"/>
    <delete dir="Info"/>
    <delete dir="javadoc"/>
    <!-- See target 'release-helper': -->
    <delete dir="release-work"/>
  </target>

  <target name="real-clean" depends="clean">
    <delete dir="reload"/>
  </target>

  <!-- For use when making new releases: -->
  <target name="ensure-def-release-sourcepath" unless="release-sourcepath">
    <fail message="You must define the variable release-sourcepath: should be root of ant checkout"/>
  </target>
  <target name="ensure-def-release-version" unless="release-version">
    <fail message="You must define the variable release-version: e.g. 1.4"/>
  </target>
  <target name="release-helper" depends="ensure-def-release-sourcepath,ensure-def-release-version" description="Help do some things useful when bundling a new Ant release.">
    <property name="release-source-root" location="${release-sourcepath}/src/main"/>
    <echo>1.  Will create a snapshot of "useful" Java sources from ${release-source-root}...</echo>
    <property name="useful-sources" location="release-work/useful-sources"/>
    <delete dir="${useful-sources}"/>
    <mkdir dir="${useful-sources}"/>
    <copy todir="${useful-sources}">
      <fileset dir="${release-source-root}">
        <include name="org/apache/tools/**/*.java"/>
        <!-- Do not forget about the package list for Javadoc below... -->
      </fileset>
    </copy>
    <property name="ant-api.zip" location="docs/release/docs/ant-api.zip"/>
    <echo>2.  Will produce Javadoc for these at ${ant-api.zip}...</echo>
    <property name="javadoc-out" location="release-work/javadoc-out"/>
    <delete dir="${javadoc-out}"/>
    <mkdir dir="${javadoc-out}"/>
    <javadoc
      packagenames="org.apache.tools.ant.*,org.apache.tools.bzip2.*,org.apache.tools.mail.*,org.apache.tools.tar.*,org.apache.tools.zip.*,org.apache.tools.ant.filters.*,org.apache.tools.ant.helper.*,org.apache.tools.ant.input.*,org.apache.tools.ant.listener.*,org.apache.tools.ant.taskdefs.*,org.apache.tools.ant.types.*,org.apache.tools.ant.util.*,org.apache.tools.ant.filters.util.*,org.apache.tools.ant.taskdefs.compilers.*,org.apache.tools.ant.taskdefs.condition.*,org.apache.tools.ant.taskdefs.cvslib.*,org.apache.tools.ant.taskdefs.email.*,org.apache.tools.ant.taskdefs.optional.*,org.apache.tools.ant.taskdefs.rmic.*,org.apache.tools.ant.taskdefs.optional.ccm.*,org.apache.tools.ant.taskdefs.optional.clearcase.*,org.apache.tools.ant.taskdefs.optional.depend.*,org.apache.tools.ant.taskdefs.optional.dotnet.*,org.apache.tools.ant.taskdefs.optional.ejb.*,org.apache.tools.ant.taskdefs.optional.extension.*,org.apache.tools.ant.taskdefs.optional.i18n.*,org.apache.tools.ant.taskdefs.optional.ide.*,org.apache.tools.ant.taskdefs.optional.j2ee.*,org.apache.tools.ant.taskdefs.optional.javacc.*,org.apache.tools.ant.taskdefs.optional.jdepend.*,org.apache.tools.ant.taskdefs.optional.jlink.*,org.apache.tools.ant.taskdefs.optional.jsp.*,org.apache.tools.ant.taskdefs.optional.junit.*,org.apache.tools.ant.taskdefs.optional.metamata.*,org.apache.tools.ant.taskdefs.optional.net.*,org.apache.tools.ant.taskdefs.optional.perforce.*,org.apache.tools.ant.taskdefs.optional.pvcs.*,org.apache.tools.ant.taskdefs.optional.scm.*,org.apache.tools.ant.taskdefs.optional.sitraka.*,org.apache.tools.ant.taskdefs.optional.sos.*,org.apache.tools.ant.taskdefs.optional.sound.*,org.apache.tools.ant.taskdefs.optional.splash.*,org.apache.tools.ant.taskdefs.optional.starteam.*,org.apache.tools.ant.taskdefs.optional.vss.*,org.apache.tools.ant.taskdefs.optional.depend.constantpool.*,org.apache.tools.ant.taskdefs.optional.extension.resolvers.*,org.apache.tools.ant.taskdefs.optional.jsp.compilers.*,org.apache.tools.ant.taskdefs.optional.sitraka.bytecode.*,org.apache.tools.ant.taskdefs.optional.sitraka.bytecode.attributes.*,org.apache.tools.ant.types.optional.*,org.apache.tools.ant.types.selectors.*,org.apache.tools.ant.types.optional.depend.*,org.apache.tools.ant.util.depend.*,org.apache.tools.ant.util.facade.*,org.apache.tools.ant.util.optional.*,org.apache.tools.ant.util.regexp.*,org.apache.tools.ant.util.depend.bcel.*"
      destdir="${javadoc-out}"
      protected="true"
      windowtitle="Ant ${release-version} Javadoc"
      doctitle="Ant ${release-version} Javadoc"
      version="false"
      use="false"
      author="false"
      splitindex="false"
      nodeprecatedlist="true"
      notree="true"
      nohelp="true"
      failonerror="true"
      >
      <sourcepath>
        <pathelement location="${useful-sources}"/>
      </sourcepath>
    </javadoc>
    <delete file="${ant-api.zip}"/>
    <zip zipfile="${ant-api.zip}">
      <fileset dir="${javadoc-out}"/>
    </zip>
    <property name="orig-manual" location="${release-sourcepath}/docs/manual"/>
    <echo>3.  Doing some preparation of the Ant manual, taken from ${orig-manual}...</echo>
    <property name="online-manual" location="release-work/online-manual"/>
    <delete dir="${online-manual}"/>
    <mkdir dir="${online-manual}"/>
    <copy todir="${online-manual}">
      <fileset dir="${orig-manual}" excludesfile="../nbbuild/standard-jar-excludes.txt">
        <!-- These are obviated by JavaHelp: -->
        <exclude name="coretasklist.html"/>
        <exclude name="optionaltasklist.html"/>
        <exclude name="index.html"/>
        <exclude name="toc.html"/>
        <!-- Presumably you do not care about other IDE integrations at this point: -->
        <exclude name="ide.html"/>
        <exclude name="Integration/"/>
        <!-- Does not apply inside NetBeans: -->
        <exclude name="running.html"/>
        <!-- Included as a separate Javadoc mount: -->
        <exclude name="api/"/>
      </fileset>
    </copy>
    <property name="install.html" location="${online-manual}/install.html"/>
    <property name="ant-docs.zip" location="external/ant-docs-${release-version}.zip"/>
    <property name="here" location="."/>
    <property name="ParserDB" location="docs/release/system/ParserDB"/>
    <property name="features.xml" location="www/plans/features.xml"/>
    <property name="ant.jar" location="external/ant-${release-version}.jar"/>
    <property name="ant-optional.jar" location="external/ant-optional-${release-version}.jar"/>
    <echo>Now some (currently) manual steps for you:
4.  Edit ${install.html}:
    - remove everything but Library Dependencies
    - libraries are needed not in classpath, but NBINSTALL/modules/patches/org-apache-tools-ant-module/
    - Jakarta regexp is already available in the IDE by default
5.  Recreate ${ant-docs.zip}.master from the contents of ${online-manual}
6.  Ensure these files in ${here} match the actual contents of ${online-manual}:
    - docs/javahelp/org/apache/tools/ant/module/docs/TOC.toc
    - docs/javahelp/org/apache/tools/ant/module/docs/Map.jhm
7.  Mention that the Ant version is ${release-version} in these files in ${here}:
    - docs/javahelp/org/apache/tools/ant/module/docs/HelpSet.hs
    - docs/javahelp/org/apache/tools/ant/module/docs/TOC.toc
    - docs/src/org/apache/tools/ant/module/docs/Bundle.properties
    - src/org/apache/tools/ant/module/resources/SampleProject.xml_
    - src/org/apache/tools/ant/module/resources/CustomTask_java
    - ../usersguide/javahelp/org/netbeans/modules/usersguide/ant/*.html
    - manifest.mf
    - build.xml
    - external/build.xml
    - external/.cvsignore
7a. Make sure OpenIDE-Module-Public-Packages in manifest.mf lists all packages
    actually present in ant.jar. Can use wildcard .** but not for org.apache.tools.ant
    package itself since that would cause all module classes to be public, not just the
    proper API packages.
8.  Update ${ParserDB} with sources from ${useful-sources}
9.  Update ${features.xml}
10. Refresh these files with the prebuilt binaries from an Ant download:
    - ${ant.jar}.master
    - ${ant-optional.jar}.master
    (and scramble them by running 'scramble' in external/build.xml)
11. Test everything
12. Submit a patch for cvs://cvs.apache.org/ant/xdocs/external.xml
    mentioning that the bundled version in NB is now ${release-version}.

After that you should be done!
</echo>
  </target>

    <target name="javadoc" description="Build Javadoc.">
        <ant dir="../nbbuild/javadoctools" antfile="template.xml" target="javadoc">
            <property name="javadoc.base" location="."/>
            <property name="javadoc.name" value="AntModuleAPI"/>
            <property name="javadoc.title" value="Ant Module API"/>
            <property name="javadoc.packages" value="org.apache.tools.ant.module.api,org.apache.tools.ant.module.spi"/>
            <property name="javadoc.classpath" refid="cp"/>
            <property name="javadoc.apichanges" location="api/doc/changes/apichanges.xml"/>
            <property name="javadoc.docfiles" location="api/doc"/>
            <property name="javadoc.arch" location="arch/arch-ant-main.xml"/>
            <property name="javadoc.manifest" location="manifest.mf"/>
        </ant>
    </target>
  
</project>
